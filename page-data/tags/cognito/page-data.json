{"componentChunkName":"component---src-templates-tags-template-tsx","path":"/tags/cognito/","result":{"pageContext":{"nodes":[{"html":"<h2 id=\"なにこれ\" style=\"position:relative;\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-label=\"なにこれ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>AppSync + Cognitoにおける認可制御について<a href=\"https://takumon.com/aws-appsync-auth-with-cognito\">以前の記事</a>で説明しました。\n今回は、ユーザーのカスタム属性を使った認可制御（AppSyncのリゾルバーでカスタム属性を取得する方法）についてご紹介します。</p>\n<h2 id=\"tldr\" style=\"position:relative;\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h2>\n<p>AppSyncとCognitoを連携済みであれば、3ステップで実現できます。</p>\n<ol>\n<li><a href=\"#1-cognito%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E5%B1%9E%E6%80%A7%E3%82%92readable%E3%81%AB%E8%A8%AD%E5%AE%9A\">サーバー側：Cognitoの設定でカスタム属性をReadableに設定</a></li>\n<li><a href=\"#2-appsync%E3%81%AE%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%A6ctxidentityclaimsgetcustomsamplecustomattr%E3%82%92%E8%A8%98%E8%BF%B0\">サーバー側：AppSyncのリゾルバーにて<code class=\"language-text\">$ctx.identity.claims.get(\"custom:sampleCustomAttr\")</code>を記述</a></li>\n<li><a href=\"#3-amplify%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%81%AEgetaccesstoken%E3%81%AE%E9%83%A8%E5%88%86%E3%82%92getidtoken%E3%81%AB%E7%BD%AE%E6%8F%9B\">クライアント側：Amplifyのライブラリの中身の<code class=\"language-text\">getAccessToken</code>の部分を<code class=\"language-text\">getIdToken</code>に置換</a></li>\n</ol>\n<p>以下で詳しく説明します。</p>\n<h2 id=\"1-cognitoの設定でカスタム属性をreadableに設定\" style=\"position:relative;\"><a href=\"#1-cognito%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E5%B1%9E%E6%80%A7%E3%82%92readable%E3%81%AB%E8%A8%AD%E5%AE%9A\" aria-label=\"1 cognitoの設定でカスタム属性をreadableに設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Cognitoの設定でカスタム属性をReadableに設定</h2>\n<p>この方法は認証時にIDトークンを使うことが前提です。<br/>\nIDトークンを使えば、ユーザー情報がAppSyncのリゾルバー取得できます。<br/>\nただしカスタム属性はデフォルトだと取得できないので、AWSコンソールにて以下のように設定しましょう。</p>\n<ul>\n<li><code class=\"language-text\">AWSコンソール</code> > <code class=\"language-text\">Cognitoのユーザープール</code> > <code class=\"language-text\">全般設定</code> > <code class=\"language-text\">アプリクライアント</code> > <code class=\"language-text\">詳細を表示</code> を選択</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2c1713bfd71ba6c95cfb7cea26398aab/29007/how-to-setting-in-cognito-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABcRAAAXEQHKJvM/AAABo0lEQVR42n2RXWsTQRSG9x/3ygvBqKVpEU0UL/QvCF4J0guhYWMhpWiLCIWsbvbjpJvtJiFs5mNndmZ25siuaRXBHng4zBnm5X3PeHsPn7zvv3q76h0OkqeHA3jcH0D/+WvYPxrC/tFLeHTwAnr9dj6E3sEAng3fwGg8Af/z2R2nk/Pkw/Gn9d6D3jsv+PptjGSLllcWd2WMQdM0aK1FbQzWSqGQEhljXZd1jbVWXedCIOW8e7tYLEbexemZr/Mcy2LZ0KpyrKpcOp+7BObuOs/dPMtcAuBmceyuplP3IwxdnKYuW9zepS6MooYwhmEcn3gRgK8QccuYraTEFmUMNtZ2Lm9pdo6bnet2dte17hyGUXTizaLI11phsVxayiiKukZZK+RSdlHb+PofzF+0Z6VUJxi1Dn/Gsa8RcUW53VSyExTlFklRoKC0c6CUwrrd238QQvwRTINg3BQ3WM5mVmQZmjb29Q2SfIN6ufr9S87hfWXbXSBiAjDygosvx5vv52Z1OSnp1SUhZUnoIicUgPD1mnApCK+qe2Gcl0JKMw2Cj78AskxHl4A9Kq8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2c1713bfd71ba6c95cfb7cea26398aab/ba381/how-to-setting-in-cognito-1.webp 200w,\n/static/2c1713bfd71ba6c95cfb7cea26398aab/7f61c/how-to-setting-in-cognito-1.webp 400w,\n/static/2c1713bfd71ba6c95cfb7cea26398aab/d00b9/how-to-setting-in-cognito-1.webp 800w,\n/static/2c1713bfd71ba6c95cfb7cea26398aab/92f8c/how-to-setting-in-cognito-1.webp 1200w,\n/static/2c1713bfd71ba6c95cfb7cea26398aab/fad48/how-to-setting-in-cognito-1.webp 1600w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2c1713bfd71ba6c95cfb7cea26398aab/772e8/how-to-setting-in-cognito-1.png 200w,\n/static/2c1713bfd71ba6c95cfb7cea26398aab/e17e5/how-to-setting-in-cognito-1.png 400w,\n/static/2c1713bfd71ba6c95cfb7cea26398aab/5a190/how-to-setting-in-cognito-1.png 800w,\n/static/2c1713bfd71ba6c95cfb7cea26398aab/c1b63/how-to-setting-in-cognito-1.png 1200w,\n/static/2c1713bfd71ba6c95cfb7cea26398aab/29007/how-to-setting-in-cognito-1.png 1600w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2c1713bfd71ba6c95cfb7cea26398aab/5a190/how-to-setting-in-cognito-1.png\"\n            alt=\"how to setting in cognito 1\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<br/></p>\n<ul>\n<li><code class=\"language-text\">属性の読み込みおよび書き込みアクセス権限を設定する</code> > <code class=\"language-text\">読み取り可能な属性</code>　にて取得したいカスタム属性にチェックを入れて<code class=\"language-text\">アプリクライアントの変更を保存</code></li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/855f67b03032d1121c08aeced2a63a19/29007/how-to-setting-in-cognito-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 119.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAABcRAAAXEQHKJvM/AAAECElEQVR42o2UzW/cRBjG9//hUFAjNVLTIhG1VAj+JU5wiQgqpRIcuXDgVuVQbQ5QtVHogoSUNOkmm92sP7ab9X7Ya4/nwx7P+EHvbLZJUBNh6dWMLc9vnvd9n5nGRyv3ntx78OWL22sPn6/cf9S8ffdhc239q+bK2qPmJ3cfNG+tftb8eHXdxa3V9eadT79ofrvxuLn5w0/NjcdPmxvfP21u/vjz86+/2Xhx5/7nTxpvjrqt0gLTJLVJmiGeMyzGDEnGMEtSRNMZommM0WSGSZxAVwaVtaiMRWVrlFVlAaDTO33d2D/x/6QXWRRVqbXVVWVHUWRH48hO45mNxmP77uzMBmFojzsd6wWBmweDgR28G1o/DG2v368Y5xiOznYbnu+3tDGYZ5kVSoFLiXg+R5bnoJ9ozIVYzFmOlDH6d/Gdc7A8R5plliT6QfDaAQutMY1jSwtlUcAYg6qq3Ehhrb0xzHnKfQcM/JapLaazmU2zDKosIaVEmqYQQjig1hplWV4bSikH9MNwoZDeciEtl8oBCZQkCbIsRZ7nTi1Br4uiKBZAUhgGXkvnZ4iHR1YkIVRR0I6YTCYYj8cO+EHQhxQS8LDrtXRVImOZFVI4ICmMkwTRJWBBGxUFpFKLealR6gqVMSB3EDCglPdPTlv0MUkzm+XcNWVZM1pMajnnrqPcdVxCFiW0sTC2Jg415qKGQRi2yKRJmlqyDAFlqZErhWXX6TtZKs2ZgwlZoFAKQnC3mZTqQuGbE0q5wmQ6tZwUSYnCC5B1+hA9H7znQZ76yE76qMIBULu17qmXk3OFDtjueS16YZw7Y5NlLNknSSGT1I1FMkcxZ5gGgauvg9W1i8spB2G42wjCwAFzIZxCV0NjkAmOXEkXNKeyuBPDmGvKsjnlwmYXQC+4AJJCippzgOXgoxEmpz3Evg+bpqiNcYqKskQcx85aNCeR74H+ZSDtnOewUYRkOEQchpj6PthkAiQJkKXgSjqVFPP53DniZiBjsLMZmFLu2FGdSmtgpATS1KVN3qSHC+HSvlLD/wJFljk1dJvQaRCcYxRFqKgMdMtwjnmSuMZSymSbJdC7DlgnCeaMOSVkbLrONKlKUwekDYyxGAyHEKT8ppSXwNFkgpwx181hFKFWygFlWbqNqBSM5Qub/Z+UuRLQhYL2PGQHByj39oA4hqqq99Ypzu/OK0DKu14AdS6lUYKbpN017b8OzOk/beP9fWjiw2NTD0JjOTemro0utdFaG1NVBjWMtVaf13CnMR6PW0u3Lw6Vxf5eiF+2+/jtjz5+/d3D8duBO2gXh+7qs1waRdFu4+XOzman291uHx09ax8fb1H02m+3+peie9ze6nS7W51O57p41u31tl++evXdv8x18ZcaJp5NAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/855f67b03032d1121c08aeced2a63a19/ba381/how-to-setting-in-cognito-2.webp 200w,\n/static/855f67b03032d1121c08aeced2a63a19/7f61c/how-to-setting-in-cognito-2.webp 400w,\n/static/855f67b03032d1121c08aeced2a63a19/d00b9/how-to-setting-in-cognito-2.webp 800w,\n/static/855f67b03032d1121c08aeced2a63a19/92f8c/how-to-setting-in-cognito-2.webp 1200w,\n/static/855f67b03032d1121c08aeced2a63a19/fad48/how-to-setting-in-cognito-2.webp 1600w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/855f67b03032d1121c08aeced2a63a19/772e8/how-to-setting-in-cognito-2.png 200w,\n/static/855f67b03032d1121c08aeced2a63a19/e17e5/how-to-setting-in-cognito-2.png 400w,\n/static/855f67b03032d1121c08aeced2a63a19/5a190/how-to-setting-in-cognito-2.png 800w,\n/static/855f67b03032d1121c08aeced2a63a19/c1b63/how-to-setting-in-cognito-2.png 1200w,\n/static/855f67b03032d1121c08aeced2a63a19/29007/how-to-setting-in-cognito-2.png 1600w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/855f67b03032d1121c08aeced2a63a19/5a190/how-to-setting-in-cognito-2.png\"\n            alt=\"how to setting in cognito 2\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<br/></p>\n<h2 id=\"2-appsyncのリゾルバーにてctxidentityclaimsgetcustomsamplecustomattrを記述\" style=\"position:relative;\"><a href=\"#2-appsync%E3%81%AE%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%A6ctxidentityclaimsgetcustomsamplecustomattr%E3%82%92%E8%A8%98%E8%BF%B0\" aria-label=\"2 appsyncのリゾルバーにてctxidentityclaimsgetcustomsamplecustomattrを記述 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. AppSyncのリゾルバーにて$ctx.identity.claims.get(\"custom:sampleCustomAttr\")を記述</h2>\n<p>以下のようにして取得します。</p>\n<div class=\"gatsby-highlight\" data-language=\"verocity:appsyncのリゾルバー\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-verocity:appsyncのリゾルバー line-numbers\"><code class=\"language-verocity:appsyncのリゾルバー\">  #set($sampleCustomAttr = $ctx.identity.claims.get(&quot;custom:sampleCustomAttr&quot;))</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<br/>\n<h2 id=\"3-amplifyのライブラリの中身のgetaccesstokenの部分をgetidtokenに置換\" style=\"position:relative;\"><a href=\"#3-amplify%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%81%AEgetaccesstoken%E3%81%AE%E9%83%A8%E5%88%86%E3%82%92getidtoken%E3%81%AB%E7%BD%AE%E6%8F%9B\" aria-label=\"3 amplifyのライブラリの中身のgetaccesstokenの部分をgetidtokenに置換 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Amplifyのライブラリの中身のgetAccessTokenの部分をgetIdTokenに置換</h2>\n<p>手順2までを実施した場合、、AppSyncのQueryコンソール上では正常動作しますが、\nクライアント側からAmplify経由でクエリをたたいた場合は正常動作しません。</p>\n<p>なぜならAppSyncのQueryコンソールは認証時にIDトークンを使いますが、\nAmplify経由の場合はアクセストークンを使うからです。</p>\n<p>そのため、Amplify側の認証をIDトークンに切り替える必要があります。\n少し無理やりですが以下のようにAmplifyのライブラリを直接書き換えます。<br/>\nプロジェクトのnode_modules配下にて、以下のように修正します。</p>\n<div class=\"gatsby-code-title\">node_modules/@aws-amplify/api/dist/aws-amplify-api.js</div>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-diff line-numbers\"><code class=\"language-diff\"><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span> Authorization: session.getAccessToken().getJwtToken() \n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span> Authorization: session.getIdToken().getJwtToken() </span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<br/>\nこれでクエリが正常動作するようになります。<br/>\nただ直接依存ライブラリを書き換えるので、本番環境デプロイ時は、CIに忘れずに書き換え処理を追加しましょう。<br/>\n<p>※この方法は、Amplipy側のGraphQLスキーマ定義で<code class=\"language-text\">@auth</code>を使っている場合に一部機能が正常動作しなくなるので注意してください。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回はAppSync + Cognitoにおいて、AppSyncのリゾルバーでユーザーのカスタム情報を取得する方法をご紹介しました。\nAmplify側は直接ライブラリを書き換えるので、多少無理やりな対応ですが、一応これでできます。\nユーザーごとの認可情報をカスタム属性に持たせる場合は、この方法を試してみてください🍅</p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/ja_jp/appsync/latest/devguide/resolver-context-reference.html#aws-appsync-resolver-context-reference-identity\">リゾルバーのマッピングテンプレートのコンテキストリファレンス - AWS AppSync</a></li>\n<li><a href=\"https://maketips.net/tip/175/include-custom-attributes-in-cognito-claims\">Include custom attributes in cognito claims</a></li>\n<li><a href=\"https://github.com/aws-amplify/amplify-js/issues/1772\">Aws Amplify appsync API graphql cognito custom attribute · Issue #1772 · aws-amplify/amplify-js</a></li>\n<li><a href=\"https://github.com/aws-amplify/amplify-cli/issues/456\">Clarify security implications of using ID Token vs. Access Token for AppSync authorization · Issue #456 · aws-amplify/amplify-cli</a></li>\n</ul>","excerpt":"なにこれ AppSync + Cognitoにおける認可制御について以前の記事で説明しました。\n今回は、ユーザーのカスタム属性を使った認可制御（AppSyncのリゾルバーでカスタム属性を取得する方法）についてご紹介します。 TL;DR AppSyncとCognito…","frontmatter":{"slug":"/how-to-get-user-custom-attributes-in-resolver-with-amplify-appsync-cognito","title":"Amplify + Cognito + AppSyncにおいてリゾルバーでユーザのカスタム属性を取得する方法","date":"2019-04-13T07:14:40.000+09:00","tags":["Amplify","AppSync","AWS","Cognito"],"keywords":["AWS"],"thumbnail":"thumbnail/2019/04/how-to-get-user-custom-attributes-in-resolver-with-amplify-appsync-cognito.png","category":null}},{"html":"<h2 id=\"なにこれ\" style=\"position:relative;\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-label=\"なにこれ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>AppSyncはCognitoと連携して認可制御ができます。\n今回はそのやり方についてご紹介します。\nざっくりいうと以下のようなことが実現可能です。</p>\n<ul>\n<li><a href=\"#%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E5%AE%9A%E7%BE%A9%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bquery%E3%82%84mutation%E3%81%94%E3%81%A8%E3%81%AE%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%EF%BC%88%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%EF%BC%89\">✨スキーマ定義におけるQueryやMutationごとの認可制御（ユーザーグループ）</a></li>\n<li><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E9%A0%85%E7%9B%AE%E3%81%94%E3%81%A8%E3%81%AE%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%EF%BC%88%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%EF%BC%89\">💎リゾルバーにおける項目ごとの認可制御（ユーザーグループ）</a></li>\n<li><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E7%B4%B0%E3%81%8B%E3%81%AA%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%EF%BC%88%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%80%81%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%90%8D%EF%BC%89\">🎊リゾルバーにおける細かな認可制御（ユーザーグループ、ユーザー名）</a></li>\n</ul>\n<h2 id=\"スキーマ定義におけるqueryやmutationごとの認可制御ユーザーグループ\" style=\"position:relative;\"><a href=\"#%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E5%AE%9A%E7%BE%A9%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bquery%E3%82%84mutation%E3%81%94%E3%81%A8%E3%81%AE%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97\" aria-label=\"スキーマ定義におけるqueryやmutationごとの認可制御ユーザーグループ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>スキーマ定義におけるQueryやMutationごとの認可制御（ユーザーグループ）</h2>\n<p><code class=\"language-text\">@aws_auth</code>アノテーションをQueryやMutationに付与します。\n以下の例ではCognitoのユーザーグループごとに</p>\n<ul>\n<li><code class=\"language-text\">管理者</code>は登録、参照、更新、削除</li>\n<li><code class=\"language-text\">営業</code>は登録、参照、更新</li>\n<li><code class=\"language-text\">一般メンバー</code>は参照</li>\n</ul>\n<p>のように認可制御しています。</p>\n<div class=\"gatsby-code-title\">スキーマ定義における@aws_authを使った認可制御の例</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"graphql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-graphql line-numbers\"><code class=\"language-graphql\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">Mutation</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token attr-name\">createTask</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">input</span><span class=\"token punctuation\">:</span> <span class=\"token atom-input class-name\">CreateTaskInput</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">CraeteTaskPayload</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token directive function\">@aws_auth</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">cognito_groups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"sales\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></span>\t<span class=\"token attr-name\">updateTask</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">input</span><span class=\"token punctuation\">:</span> <span class=\"token atom-input class-name\">UpdateTaskInput</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UpdateTaskPayload</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token directive function\">@aws_auth</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">cognito_groups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"sales\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></span>  <span class=\"token attr-name\">deleteTask</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">input</span><span class=\"token punctuation\">:</span> <span class=\"token atom-input class-name\">DeleteTaskInput</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">DeleteTaskPayload</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token directive function\">@aws_auth</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">cognito_groups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Query</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token attr-name\">getTask</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token scalar\">ID</span><span class=\"token operator\">!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Task</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token directive function\">@aws_auth</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">cognito_groups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"sales\"</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"member\"</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<h3 id=\"デフォルトの認可制御\" style=\"position:relative;\"><a href=\"#%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%AE%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1\" aria-label=\"デフォルトの認可制御 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>デフォルトの認可制御</h3>\n<p>AppSyncではエンドポイントごとに<code class=\"language-text\">@aws_auth</code>未定義の場合の挙動を以下2つから選択できます。</p>\n<ul>\n<li><strong>ALLOW</strong>\n<ul>\n<li>認証済ユーザーであれば、すべてのユーザーを許可する</li>\n</ul>\n</li>\n<li><strong>DENY</strong>\n<ul>\n<li>認証済ユーザーであっても、すべてのユーザーを許可しない　※<code class=\"language-text\">@aws_auth</code>を定義しないとアクセスできない</li>\n</ul>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/74ebe00376b92d06597a3375e77f2767/1acf3/default-setting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABcRAAAXEQHKJvM/AAACcElEQVR42o2TW2/TQBCF8/PLa5sEenkmoDapVAnUgpQg1VQigCiqEE3aOCXOxbHdtb3e3djey0F2UkQJEYz0aaSV9+yZGU+l+6l7eHX17UO/1z/3PM9yXdcaj8fWaDSyhsOh1ev1rF6/X2IPh5YzHq8xcpzzyWzWve71DiuUUhvL0PgttNHIpUREKWjCECcJsizDhijvJkliV7a2ntxWazVUq1W5s7Ojt7e39dN6XY8mEy2V0jwM9SJJtM4yLTnXKWM6zTKd51KvhApkIUgpva30+317NpshCAIdhiEIIYgYA5s4CF+/wt3nS9xdXMDpfoT75RL0+zUYCZFm+ZrDOI7tymTq2ossg1ZqWbIxZRKMgbsuBCFgnocFITBCwHAOozW0MVBal8jVXRJFdsWbODZUutZDkaaIOUdACIIwxDwIMPM8xMVDnIML8QvGuS5seL5vV2gc/XUoYrEomoyQhCBhCN/3S/I8hzGmcLVEyuJs6ZAQe+OUC0HGOdz5HMH9femKMYYojsvzQtSs2vOoh5sEi1+kGNb+wQFq9Tqe7e5ib28ftVodrePjUqxwWzj8t6AxyJSCF4ZoNltovHiJZquFk5OTMrc7HWitl4JK/UNwVUbqjBC8OcPboybOnjfwrtUqaR8eoXt6CuV5UK5b5v8SFL4P8fUSizwv3fy5RUpJSCVL0UeCSZLcrL7LjTHqAZFlio4navBjrAhliopUxXyxRKSKpbmKRabEeFrUnK825WbjUIqQMQUPIkjKIalYI485VBQ/3mXHcRpJkliEkHYURZ0Hpq7bmc7dTnAfdDzP20wQdFzXbfu+/34wGDR+AgF4YTtp5gZPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/74ebe00376b92d06597a3375e77f2767/ba381/default-setting.webp 200w,\n/static/74ebe00376b92d06597a3375e77f2767/7f61c/default-setting.webp 400w,\n/static/74ebe00376b92d06597a3375e77f2767/d00b9/default-setting.webp 800w,\n/static/74ebe00376b92d06597a3375e77f2767/92f8c/default-setting.webp 1200w,\n/static/74ebe00376b92d06597a3375e77f2767/50d93/default-setting.webp 1596w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/74ebe00376b92d06597a3375e77f2767/772e8/default-setting.png 200w,\n/static/74ebe00376b92d06597a3375e77f2767/e17e5/default-setting.png 400w,\n/static/74ebe00376b92d06597a3375e77f2767/5a190/default-setting.png 800w,\n/static/74ebe00376b92d06597a3375e77f2767/c1b63/default-setting.png 1200w,\n/static/74ebe00376b92d06597a3375e77f2767/1acf3/default-setting.png 1596w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/74ebe00376b92d06597a3375e77f2767/5a190/default-setting.png\"\n            alt=\"default setting\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<br/></p>\n<h2 id=\"リゾルバーにおける項目ごとの認可制御ユーザーグループ\" style=\"position:relative;\"><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E9%A0%85%E7%9B%AE%E3%81%94%E3%81%A8%E3%81%AE%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97\" aria-label=\"リゾルバーにおける項目ごとの認可制御ユーザーグループ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>リゾルバーにおける項目ごとの認可制御（ユーザーグループ）</h2>\n<p>リゾルバー中でユーザーグループを参照できるので、それを使って項目ごとの認可制御ができます。\n以下の例では、<code class=\"language-text\">管理者</code>、<code class=\"language-text\">営業</code>、<code class=\"language-text\">一般ユーザー</code>のCognitoユーザーグループがある場合に、\nタスク情報の登録日と更新日については、<code class=\"language-text\">管理者</code>と<code class=\"language-text\">営業</code>のみが参照可能できるように制御しています。</p>\n<div class=\"gatsby-code-title\">ユーザーグループごとにレスポンス項目を制御する例</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\">## 一般メンバーか判定\n<span class=\"gatsby-highlight-code-line\"><span class=\"token function\">#foreach</span><span class=\"token punctuation\">(</span>$group <span class=\"token keyword\">in</span> $context<span class=\"token punctuation\">.</span>identity<span class=\"token punctuation\">.</span>claims<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cognito:groups\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span>    #<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>$group <span class=\"token operator\">==</span> <span class=\"token string\">\"member\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">#set</span><span class=\"token punctuation\">(</span>$isMember <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    #end\n#end\n\n<span class=\"token function\">#set</span><span class=\"token punctuation\">(</span>$result<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n$util<span class=\"token punctuation\">.</span><span class=\"token function\">qr</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n$util<span class=\"token punctuation\">.</span><span class=\"token function\">qr</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"discription\"</span><span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>discription<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n$util<span class=\"token punctuation\">.</span><span class=\"token function\">qr</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"owner\"</span><span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>owner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n## <span class=\"token function\">一般メンバーには返さない</span><span class=\"token punctuation\">(</span>管理者と営業のみ参照できる<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">#<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>$isMember<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  $util<span class=\"token punctuation\">.</span><span class=\"token function\">qr</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"created\"</span><span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>created<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  $util<span class=\"token punctuation\">.</span><span class=\"token function\">qr</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"updated\"</span><span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>updated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">#end</span>\n$util<span class=\"token punctuation\">.</span><span class=\"token function\">toJson</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"リゾルバーにおける細かな認可制御ユーザーグループユーザー名\" style=\"position:relative;\"><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E7%B4%B0%E3%81%8B%E3%81%AA%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%90%8D\" aria-label=\"リゾルバーにおける細かな認可制御ユーザーグループユーザー名 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>リゾルバーにおける細かな認可制御（ユーザーグループ、ユーザー名）</h2>\n<p>ユーザーグループだけではなくユーザー名でも認可制御が可能です。\n例えば「<code class=\"language-text\">一般ユーザー</code>は自分が登録した情報のみ参照でき、<code class=\"language-text\">管理者</code>はすべて参照できる」のような要件を実現する場合です。\nここではAppSync + Cognito + Dynamoの例を考えます。\nまずタスクテーブルに「owner」カラムを設けて、タスクを登録者のCognitoユーザー名を登録しておきます。</p>\n<p><strong>タスクテーブル</strong></p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>description</th>\n<th>owner</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>123</td>\n<td>今週のブログ書く</td>\n<td>takumon</td>\n</tr>\n<tr>\n<td>124</td>\n<td>CodeBuildとGitHubのプルリク連携を調べる</td>\n<td>takumon</td>\n</tr>\n<tr>\n<td>125</td>\n<td>今週のGoogle Cloud Platform Podcast聞く</td>\n<td>inoue</td>\n</tr>\n</tbody>\n</table>\n<br/>\n<p>そして更新用レスポンスマッピングテンプレートで以下のようにします。</p>\n<div class=\"gatsby-code-title\">ユーザーグループとユーザー名で認可制御する例</div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\">## 管理者か判定\n<span class=\"gatsby-highlight-code-line\"><span class=\"token function\">#foreach</span><span class=\"token punctuation\">(</span>$group <span class=\"token keyword\">in</span> $context<span class=\"token punctuation\">.</span>identity<span class=\"token punctuation\">.</span>claims<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cognito:groups\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span>  #<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>$group <span class=\"token operator\">==</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">#set</span><span class=\"token punctuation\">(</span>$isAdmin <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n  #end\n#end\n\n<span class=\"token function\">#set</span><span class=\"token punctuation\">(</span>$result <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n## 管理者はすべてのタスクを参照できる\n#<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>$isAdmin<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">#set</span><span class=\"token punctuation\">(</span>$result <span class=\"token operator\">=</span> $context<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">)</span>\n#<span class=\"token keyword\">else</span>\n  ## 一般ユーザーは自分が登録したタスクのみ参照できる\n  <span class=\"token function\">#foreach</span><span class=\"token punctuation\">(</span>$item <span class=\"token keyword\">in</span> $context<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    #<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>$item<span class=\"token punctuation\">.</span>owner <span class=\"token operator\">==</span> $context<span class=\"token punctuation\">.</span>identity<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">)</span></span>      <span class=\"token function\">#set</span><span class=\"token punctuation\">(</span>$myResults<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>$item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    #end\n  #end\n#end\n$utils<span class=\"token punctuation\">.</span><span class=\"token function\">toJson</span><span class=\"token punctuation\">(</span>$results<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<p>これで<code class=\"language-text\">takumon</code>の場合は2件、<code class=\"language-text\">inoue</code>の場合は1件、<code class=\"language-text\">管理者</code>の場合は3件参照できるようになります。\nなお<code class=\"language-text\">$util.unauthorized()</code>を使えば認可エラーを返せます。\nリゾルバーの書き方しだいで複雑な要件も実現できるでしょう。</p>\n<h2 id=\"クライアント側\" style=\"position:relative;\"><a href=\"#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4\" aria-label=\"クライアント側 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>クライアント側</h2>\n<p>なおCognitoと連携する場合、クライアント側も対応が必要です。</p>\n<h3 id=\"vue--apmlifyの場合\" style=\"position:relative;\"><a href=\"#vue--apmlify%E3%81%AE%E5%A0%B4%E5%90%88\" aria-label=\"vue  apmlifyの場合 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vue + Apmlifyの場合</h3>\n<p>Vue + Apmlifyの場合は以下のようにします。<a href=\"https://github.com/Takumon/vue-amplify-sample/blob/master/src/main.js\">参考ソースコード</a></p>\n<div class=\"gatsby-code-title\">Vue</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript+ apmlifyの場合のcognito連携設定\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript+ apmlifyの場合のcognito連携設定 line-numbers\"><code class=\"language-javascript+ apmlifyの場合のcognito連携設定\">import Amplify, { Auth } from &#39;aws-amplify&#39;;\nimport { AmplifyPlugin } from &#39;aws-amplify-vue&#39;;\n\n// 環境変数から読み込み\nconst config = {\n  aws_project_region: process.env.VUE_APP_AWS_PROJECT_REGION,\n  aws_appsync_graphqlEndpoint: process.env.VUE_APP_AWS_APPSYNC_GRAPHQLENDPOINT,\n  aws_appsync_region: process.env.VUE_APP_AWS_APPSYNC_REGION,\n  aws_appsync_authenticationType: process.env.VUE_APP_AWS_APPSYNC_AUTHENTICATIONT_TYPE,\n  Auth: {\n    identityPoolId: process.env.VUE_APP_AWS_COGNIT_IDENTITY_POOL_ID,\n    region: process.env.VUE_APP_AWS_COGNIT_REGION,\n    identityPoolRegion: process.env.VUE_APP_AWS_COGNIT_IDENTITY_POOL_REGION,\n    userPoolId: process.env.VUE_APP_AWS_COGNIT_USER_POOL_ID,\n    userPoolWebClientId: process.env.VUE_APP_AWS_COGNIT_USER_POOL_WEB_CLIENT_ID,\n  },\n};\n\nAmplify.configure(config);\nVue.use(AmplifyPlugin, Amplify);</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<p>次にログイン画面を作ります。\nAmplifyが用意している<code class=\"language-text\">&lt;amplify-authenticator></code>タグで簡単に実現できます。<a href=\"https://github.com/Takumon/vue-amplify-sample/blob/master/src/views/Home.vue#L3-L5\">参考ソースコード</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/631943853fa0cf3d15f7bf565aef235a/64d87/how-to-client-login-0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABx0lEQVR42q2UzW7TQBSF/QDwMix5Q8SqQioVa4Rg2QLrsgdFDmklEJEdAqYeJ+OMHdvN/Nw51bUdUEqUNFUtfZofXR+de8bjIAzDF1LKb2mafklTMUiFGAgm7ce78VlK+X00Gh0F0+n0IwAQkcM9n/W7SZKcBePx+D0vtNZGzOYkF4ryhaK5zKmqG+L6fRCRYY04jk+DKIo+8GKltZtMf2Mmc2SzOX79uUKxrA5yOJlMzoI4jltBa51bVjUYY+29Wt4QNMa4fKHArFYrOOdaiGgvjgtvC/Jm09QoigJVVUEp1WL3uN0p6L1fF9zZYV/3TzCK4r+HIvMFcqWgtXmYDIuyBKO1bls1xux1+Z/DzQwblGXZZbhQUEWBvvbwDK21jk+XXXVYOF2DTA3i0a5AzoCsvgV3QdsdsjN2yWNVX8M1ErgWQHMFmOVhGfLmOhfvCeDb5B1Atr9hAH68AcLnwOVL4OK4m4/fbRfUWjvOryiWqJcKKGOgSoDyJ2D7K/j6CfAsAF49Bk4edfO3T0G08dl0d5ljBOB3Mht4JOceyaeec4956InaNljw9OF/X2EYnkgpYyHEKMuyy52IdDtZ9lVKORkOh8c3gvhaQZoCQcIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/631943853fa0cf3d15f7bf565aef235a/ba381/how-to-client-login-0.webp 200w,\n/static/631943853fa0cf3d15f7bf565aef235a/7f61c/how-to-client-login-0.webp 400w,\n/static/631943853fa0cf3d15f7bf565aef235a/d00b9/how-to-client-login-0.webp 800w,\n/static/631943853fa0cf3d15f7bf565aef235a/3a941/how-to-client-login-0.webp 818w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/631943853fa0cf3d15f7bf565aef235a/772e8/how-to-client-login-0.png 200w,\n/static/631943853fa0cf3d15f7bf565aef235a/e17e5/how-to-client-login-0.png 400w,\n/static/631943853fa0cf3d15f7bf565aef235a/5a190/how-to-client-login-0.png 800w,\n/static/631943853fa0cf3d15f7bf565aef235a/64d87/how-to-client-login-0.png 818w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/631943853fa0cf3d15f7bf565aef235a/5a190/how-to-client-login-0.png\"\n            alt=\"how to client login 0\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<br/></p>\n<h3 id=\"awsコンソールの場合\" style=\"position:relative;\"><a href=\"#aws%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%81%AE%E5%A0%B4%E5%90%88\" aria-label=\"awsコンソールの場合 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AWSコンソールの場合</h3>\n<p>手っ取り早く試すなら、AppSyncのQuery実行画面に認証機能があるので、そちらで試しましょう。</p>\n<ul>\n<li>Query実行画面の実行ボタン左側の<code class=\"language-text\">Login with User Pools</code>というボタンをクリックします。</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/64ff5487a7a824a57aa9cb743bc3ebcd/e515d/how-to-client-login-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABcRAAAXEQHKJvM/AAACi0lEQVR42s2U20tUURTG549LiBIifQincUq6iFqSENRbLxJqOFOTmjqgEVpYhIE3BkKGauihlLKMMxQ1nbnpzPF4rvvc9j5fnD3jpDAP1VMLPtaBs9dvf2uvzQ6daDs7E+7q/dl7ZeBL58WrwqW+68L57gGhp/+m0N1/QzgT7RFa26NCy8l24VjLceHU6XYhHIkKHeFOoaMjIkSiF4Rzl69th7v68q1tkelQPp9PAQBjjKIePgDXY9gnLnarEpLJJMbGJxCPx/E2k+FrKGXwfXBRWqstFosrobXV1bXlpSW8WFx0ny4ssI2NDRbwJWmPbWe/MbFcZfuVKpPLO2yvIjGF2EzTDaapGtM0nUtVNTcAlko7y6FXmUwq/foNXqbTdH19HdlsljtQDQvy13eQ0k8gvd9E5eMW9rY+QX/+DKRcguV6sAiBaRIoqlZ3WF4J5bc/pyBVQIsFynuttQ/dIPB0CWz3O6gkwZNlUFmGncuBKBosx4Fl2yCWBU03fwPFD5splPJwRZFSz4Pv+zWgroPSxrE2wqUMqqxBkTWYpgViOzBMwheWy4HD+lB8329U14AGgg0aJx8IPjzbgVxVsVuWYUgaTMWArug1YPEw8NCUG8AmDm3Lga6bII4DYtkgxIJhmE2AzRw2ATqOC9OyarC6Gi3/C9B1PZjE/k+AhBA+bdM04Xkel207R2B/AdQ5IPgO9McOczmRAz3Po0GLQbHrulAUlWfG/MbdDGTbHMAVXH7dJFA1gwMLhUJzhwcPhI/mwfyjfw4eFn6xB4di88nZeen+5ExuenZOTD58LA6Njom3RxLiyN0HXHfuTXINxyd4Hk1M8TwUGxNjiSlxODb+IzE5I98aHHn0C7oShx7REoRAAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/64ff5487a7a824a57aa9cb743bc3ebcd/ba381/how-to-client-login-1.webp 200w,\n/static/64ff5487a7a824a57aa9cb743bc3ebcd/7f61c/how-to-client-login-1.webp 400w,\n/static/64ff5487a7a824a57aa9cb743bc3ebcd/d00b9/how-to-client-login-1.webp 800w,\n/static/64ff5487a7a824a57aa9cb743bc3ebcd/92f8c/how-to-client-login-1.webp 1200w,\n/static/64ff5487a7a824a57aa9cb743bc3ebcd/fa512/how-to-client-login-1.webp 1430w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/64ff5487a7a824a57aa9cb743bc3ebcd/772e8/how-to-client-login-1.png 200w,\n/static/64ff5487a7a824a57aa9cb743bc3ebcd/e17e5/how-to-client-login-1.png 400w,\n/static/64ff5487a7a824a57aa9cb743bc3ebcd/5a190/how-to-client-login-1.png 800w,\n/static/64ff5487a7a824a57aa9cb743bc3ebcd/c1b63/how-to-client-login-1.png 1200w,\n/static/64ff5487a7a824a57aa9cb743bc3ebcd/e515d/how-to-client-login-1.png 1430w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/64ff5487a7a824a57aa9cb743bc3ebcd/5a190/how-to-client-login-1.png\"\n            alt=\"how to client login 1\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<br/></p>\n<ul>\n<li>ログインモーダルが出てきます。接続先のCognitのクライアントID、ユーザー名、パスワードを入力すればOKです。</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7dbf3e3ff6387c960ef78f8f03e4b221/95e59/how-to-client-login-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABcRAAAXEQHKJvM/AAACKUlEQVR42oWU7W7TMBSGe5tcBPeBBEiIH9wFv0ATYh1MlRgIdVq3gbqsH87aps5Hl8Z2kzqxnRc5SVm7rduRHh372H517GO7dXLy691s5v123Ztj13U7hLgd1510yHW/Q/6cdch4WMUIIc1YPb7LzfFkMu2enp69bk2n0zYAlGWpa487a9o2ts39mDH12iCIDlpXV85X24njZUEpNUEQmvmcGkp94/uBob5v0jQ16/V6hyzb+MxwzgurQQj53Or3nSrDJEl0EASIFgvMqY8gDBFFEcIogpQSSqlHKYoCWZZVGY7H44NW37muBKXMtcxzPGZlWT5g24w2teDICpJJGxc9CMfR82hRZRUEIYQQMEZD64fYzHYEjdnK8HrQhhBY3S50FMdI0wxFoSq0NnvZK+iQmzb+XiIdDXSUMORS2glQWu3n2QyzDCy61TMagokUuSohC7OXQhmgNIBWFaYotgTtGV6eY+kMNQkFvIBjwdWT8Lqoe7bcXBvdBJ+zsjRQRiOnFPr8BPriO9Tw8q7KTnNt8qLQqqpgU8mmre5VWK7XoHEM//Ab2PuXWH54AfHxbSU4GgzuBJOEaca49ah8005Y3d/AuahZS7CYg9EFkmjZbNmtBL8YXUJwIQUXijGuOONKiNUuXPyH23kJU0ysFFul1kt7lcZj8unpz+HJs7SFLis2L6X6HLrd7hvf9394nnfoed7RbOYdWf8cdt6G6dSunf/s9S5e/QMburahIwUk9QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7dbf3e3ff6387c960ef78f8f03e4b221/ba381/how-to-client-login-2.webp 200w,\n/static/7dbf3e3ff6387c960ef78f8f03e4b221/7f61c/how-to-client-login-2.webp 400w,\n/static/7dbf3e3ff6387c960ef78f8f03e4b221/d00b9/how-to-client-login-2.webp 800w,\n/static/7dbf3e3ff6387c960ef78f8f03e4b221/92f8c/how-to-client-login-2.webp 1200w,\n/static/7dbf3e3ff6387c960ef78f8f03e4b221/7bd19/how-to-client-login-2.webp 1460w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7dbf3e3ff6387c960ef78f8f03e4b221/772e8/how-to-client-login-2.png 200w,\n/static/7dbf3e3ff6387c960ef78f8f03e4b221/e17e5/how-to-client-login-2.png 400w,\n/static/7dbf3e3ff6387c960ef78f8f03e4b221/5a190/how-to-client-login-2.png 800w,\n/static/7dbf3e3ff6387c960ef78f8f03e4b221/c1b63/how-to-client-login-2.png 1200w,\n/static/7dbf3e3ff6387c960ef78f8f03e4b221/95e59/how-to-client-login-2.png 1460w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7dbf3e3ff6387c960ef78f8f03e4b221/5a190/how-to-client-login-2.png\"\n            alt=\"how to client login 2\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<br/></p>\n<ul>\n<li>あとは通常のAppSyncのQuery実行画面と同じようにQueryやMutaitonを発行すれば認可制御されたレスポンスが確認できます。</li>\n</ul>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回はAppSync + Cognitoによる認可制御について紹介しました。<br/>\nQueryとMutation単位の認可制御であれば<code class=\"language-text\">@aws_auth</code>を使い、\n項目単位の認可制御はリゾルバーに任せるのがポイントです。</p>\n<p>余談ですが、<code class=\"language-text\">@aws_auth</code>は今のところユーザーグループ単位の認可制御しかできません。\nただ構文的にはユーザーグループ以外でも認可制御ができそうなので将来的に機能が追加されるのかもしれませんね🍅</p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/ja_jp/appsync/latest/devguide/security.html#amazon-cognito-user-pools-authorization\">AWS公式ドキュメント > AppSync > セキュリティ</a></li>\n<li><a href=\"https://docs.aws.amazon.com/ja_jp/appsync/latest/devguide/security-authorization-use-cases.html\">AWS公式ドキュメント > AppSync > セキュリティ > 認証のユースケース</a></li>\n</ul>","excerpt":"なにこれ AppSyncはCognitoと連携して認可制御ができます。\n今回はそのやり方についてご紹介します。\nざっくりいうと以下のようなことが実現可能です。 ✨スキーマ定義におけるQueryやMutation…","frontmatter":{"slug":"/aws-appsync-auth-with-cognito","title":"AppSync + Cognitoによる認可制御","date":"2019-03-17T17:45:00.000+09:00","tags":["AppSync","AWS","Cognito"],"keywords":["AWS"],"thumbnail":"thumbnail/2019/03/aws-appsync-auth-with-cognito.png","category":null}}],"tag":"Cognito","tagCounts":[{"text":"Gatsby","size":26},{"text":"React","size":8},{"text":"Vue.js","size":8},{"text":"GraphQL","size":6},{"text":"AWS","size":5},{"text":"AppSync","size":5},{"text":"Vuetify","size":5},{"text":"GatsbyPlugin","size":4},{"text":"Netlify","size":3},{"text":"VueI18n","size":3},{"text":"WordCloud","size":3},{"text":"d3.js","size":3},{"text":"d3Cloud","size":3},{"text":"kuromoji.js","size":3},{"text":"mdx-deck","size":3},{"text":"キーボード","size":3},{"text":"データ可視化","size":3},{"text":"勉強会","size":3},{"text":"形態素解析","size":3},{"text":"Apollo Client","size":2},{"text":"AutoHotkey","size":2},{"text":"Cognito","size":2},{"text":"CrossPlatform","size":2},{"text":"LT","size":2},{"text":"Mobile","size":2},{"text":"Node.js","size":2},{"text":"Nuxt.js","size":2},{"text":"ReactNative","size":2},{"text":"SNS","size":2},{"text":"SRE","size":2},{"text":"VeeValidate","size":2},{"text":"code-surfer","size":2},{"text":"gatsby-image","size":2},{"text":"markdown","size":2},{"text":"mdx","size":2},{"text":"スライド","size":2},{"text":"ブログ","size":2},{"text":"プレゼン","size":2},{"text":"作業効率化","size":2},{"text":"読書感想","size":2},{"text":"Amplify","size":1},{"text":"Axios","size":1},{"text":"CSS","size":1},{"text":"CSSModules","size":1},{"text":"CircleCI","size":1},{"text":"Connpass","size":1},{"text":"Cytoscape.js","size":1},{"text":"DynamoDB","size":1},{"text":"Flutter","size":1},{"text":"Fromik","size":1},{"text":"Gatsby theme","size":1},{"text":"Git","size":1},{"text":"GitHub","size":1},{"text":"Github-Pages","size":1},{"text":"Graphpack","size":1},{"text":"Https化","size":1},{"text":"Hugo","size":1},{"text":"Iframely","size":1},{"text":"Ionic","size":1},{"text":"JJUG CCC","size":1},{"text":"JSON-LD","size":1},{"text":"Java","size":1},{"text":"JavaScript","size":1},{"text":"Kotlin","size":1},{"text":"NetlifyForms","size":1},{"text":"OGP","size":1},{"text":"PWA","size":1},{"text":"RPG","size":1},{"text":"RSS","size":1},{"text":"SER","size":1},{"text":"Schema-org","size":1},{"text":"Vim","size":1},{"text":"Vimium","size":1},{"text":"Vuex","size":1},{"text":"Windows","size":1},{"text":"Zapier","size":1},{"text":"clip-path","size":1},{"text":"gatsby-image-sharp","size":1},{"text":"gatsby-plugin-feed","size":1},{"text":"gatsy-image","size":1},{"text":"golang","size":1},{"text":"oEmbed","size":1},{"text":"rehype","size":1},{"text":"remark","size":1},{"text":"serverless","size":1},{"text":"typescript","size":1},{"text":"unified","size":1},{"text":"イベントレポート","size":1},{"text":"カスタムドメイン","size":1},{"text":"デュアルキーボード","size":1},{"text":"パソコン","size":1},{"text":"ランチャー","size":1},{"text":"リンク集","size":1},{"text":"埋め込みコード","size":1},{"text":"肩こり","size":1}]}},"staticQueryHashes":["3868140423","4185443638","467257065"],"slicesMap":{}}