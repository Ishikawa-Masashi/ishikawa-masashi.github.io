{"componentChunkName":"component---src-templates-tags-template-tsx","path":"/tags/d-3-js/","result":{"pageContext":{"nodes":[{"html":"<h2 id=\"なにこれ\" style=\"position:relative;\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-label=\"なにこれ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p><a href=\"/wordcloud-with-kuromoji-d3cloud-nodejs\">前回記事</a>ではNode.jsでWordCloudを出力しました。\n今回は、<a href=\"https://github.com/Takumon/playbox2019/blob/master/node-kuromoji-d3cloud-sample/index.js\">前回のサンプル</a>をベースに自分のブログ（Gatsby製のブログ）にWordCloudを取り入れてみたので、その時の実装方法のメモです。</p>\n<p>※ソースコードは以下です。<br/>\n<a href=\"https://github.com/Takumon/blog/blob/master/gatsby-node.js\">https://github.com/Takumon/blog/blob/master/gatsby-node.js</a></p>\n<h2 id=\"wordcloudどんなかんじ\" style=\"position:relative;\"><a href=\"#wordcloud%E3%81%A9%E3%82%93%E3%81%AA%E3%81%8B%E3%82%93%E3%81%98\" aria-label=\"wordcloudどんなかんじ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WordCloudどんなかんじ？</h2>\n<p>(1)記事全文をインプットにしたものと、(2)記事のタグをインプットにしたものの2つを生成しました。<a href=\"./map\">全記事解析ページ</a>で見れます。</p>\n<h3 id=\"1記事全文をインプットにしたもの\" style=\"position:relative;\"><a href=\"#1%E8%A8%98%E4%BA%8B%E5%85%A8%E6%96%87%E3%82%92%E3%82%A4%E3%83%B3%E3%83%97%E3%83%83%E3%83%88%E3%81%AB%E3%81%97%E3%81%9F%E3%82%82%E3%81%AE\" aria-label=\"1記事全文をインプットにしたもの permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>(1)記事全文をインプットにしたもの</h3>\n<p>キーワード以外にも、「登録」「実現」「まとめ」のような何回も使う表現がノイズとして混ざるのであまり満足度は高くありません。それでも「Gatsby」「React」が目立って表示されているので、形だけはWordCloudになっています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d54597d54916946ac04e434744ea4221/29007/wordcloud-from-texts.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABcRAAAXEQHKJvM/AAACBklEQVR42hXR2U7bQBQAUP//X/S5dBG8VFUrVWqAEpIQcBxjxx7PPnf2GS8k9Knq+YVT2Bx8ijHGkE304KMSVl0EOCaoGgYrwRgXpLcuB5miizFM0zSnOC/nIie3uDB6m5MxgEW0APx8UqF/bvQeqxfOQUPujGWYSIUESK9gjm6Z5mIO8BbExFweJGV9TV3TlrxXvN/1eMvZpqJEMVcD3zeDUEQrGi1zIJc5F2aMWAVbv6Y/K0H79Svv6z3ab3eM3g3NlrGhwZRAh/sTiF4rbWQnjga6aU4FgE4MzuUOnp4o5Q+16O8e2O8Vw8/ytCasAzSsK4QPZXhdAzt1NlRKKq2CTcWFoEmHpr6X1X2sO9wMmXRaDrw5kuMjq4+47p63pUadb2/fj/eac4xi4nRMsZh85ApeRPPe3h7Lz18OV9+766/Vh5vy09Xm4/Xh2+Opio2zYicNeyOlow2ImDReZihcVNSBN3Ikmpf7h+bnE/qxbld37WbTrq7bm1/Hl6qFHSOcCMMbgltvaTQqjb4I/3MdVWpgOvR4xr3URKCJUO0l34u2R9w0PaKGAw7DIQg0Gjtqk8/nIhuXU9TOMSeZQZ4OiiuhPONUUIQFn4Q4M6SkY54FYMkz69KY3bTkYk4q53GMPkdjA8zR5uxNtpB0nLJL0+zJJerFJR9SCPlt9nH04xj/XpZ/tYBKcGRHX0MAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d54597d54916946ac04e434744ea4221/ba381/wordcloud-from-texts.webp 200w,\n/static/d54597d54916946ac04e434744ea4221/7f61c/wordcloud-from-texts.webp 400w,\n/static/d54597d54916946ac04e434744ea4221/d00b9/wordcloud-from-texts.webp 800w,\n/static/d54597d54916946ac04e434744ea4221/92f8c/wordcloud-from-texts.webp 1200w,\n/static/d54597d54916946ac04e434744ea4221/fad48/wordcloud-from-texts.webp 1600w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d54597d54916946ac04e434744ea4221/772e8/wordcloud-from-texts.png 200w,\n/static/d54597d54916946ac04e434744ea4221/e17e5/wordcloud-from-texts.png 400w,\n/static/d54597d54916946ac04e434744ea4221/5a190/wordcloud-from-texts.png 800w,\n/static/d54597d54916946ac04e434744ea4221/c1b63/wordcloud-from-texts.png 1200w,\n/static/d54597d54916946ac04e434744ea4221/29007/wordcloud-from-texts.png 1600w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d54597d54916946ac04e434744ea4221/5a190/wordcloud-from-texts.png\"\n            alt=\"wordcloud from texts\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<br/></p>\n<h3 id=\"2記事のタグをインプットにしたもの\" style=\"position:relative;\"><a href=\"#2%E8%A8%98%E4%BA%8B%E3%81%AE%E3%82%BF%E3%82%B0%E3%82%92%E3%82%A4%E3%83%B3%E3%83%97%E3%83%83%E3%83%88%E3%81%AB%E3%81%97%E3%81%9F%E3%82%82%E3%81%AE\" aria-label=\"2記事のタグをインプットにしたもの permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>(2)記事のタグをインプットにしたもの</h3>\n<p>上記を作ってみて満足いかなかったので、試しに記事のタグをインプットにしたものを作ってみたら、思いのほかそれっぽくなりました。自分の直感とも一致していているので、「どんなブログ書いてるの？」という質問の答えとして十分使えそうです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6b221814408fff0db1c489870df79575/29007/wordcloud-from-tags.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABcRAAAXEQHKJvM/AAACXElEQVR42lWSW2/bRhSE+f9/QR8LBCj6UOShCNAYbVwXgd04sRNKliWLikRJvIg3LbnkkktySX2BbPSSAQYYzJk5T2MBnE6nZ75oOI0v2hFLgngFbc+oc9q6YxggbjRNo//Ln/vxHBqBZYaaZO+j8pyuzVF5TB55dI3mrfsbnyKHpZCgfNSxpulGDrohOx4pVIPpOgYpYP0O6iNW26aE6w3Jbs1+brOa3bOdT/HmEb8u3vHzx0fuNz4Pns/vk5C3s4irVcr7ZcSrvzd8+pqwmH8lvXsNfYmV6wzhbqnEFNVniEJQJ5pwJXjjXPHGXnHxectr+8APVy4Xi4iLxYFf7j1++rDkLyfjx8sHCvcLDC1WozVqF1Cln0mFi7teEnsJ60nCUzLj/c7mdvvEJHC4280IsyNT12dzyNgsfcJQcLNwwb0ELbHqSlE4LmVyhxen+PuQ7BByWBckgc+mWBN7D6g//yD9eIO8uaa5vqGZ3NNdXyKuPxAeCrrAw1QSqy0lUSwR1ZJaS3JVI/MG/6lAHlIaT1DOdrSTPcUionl0kM4UFT7Se0+U+4A4KglCSVF3WK0sCGRJVD4yV5LbQrEUiqmT8WUT4Ycl221B4OcMnsuwukXmKVqukFVEkRckcYmpNCdOWF0pTShLk1SOOeaJ2YvKJG5hdkFptqI2bhYar0xMGmem8zKj3J2pRWbGKjaizE2jMzMoYcYeAxjrPM4BGHmBMiMy1NC/OKeu51QLaBTInrGs6HX/POZz4sT3OD+0/8/GjHZZaJthtMd/fF3ZtPW/mWE830abZ37f/wZiDjREzphx4QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/6b221814408fff0db1c489870df79575/ba381/wordcloud-from-tags.webp 200w,\n/static/6b221814408fff0db1c489870df79575/7f61c/wordcloud-from-tags.webp 400w,\n/static/6b221814408fff0db1c489870df79575/d00b9/wordcloud-from-tags.webp 800w,\n/static/6b221814408fff0db1c489870df79575/92f8c/wordcloud-from-tags.webp 1200w,\n/static/6b221814408fff0db1c489870df79575/fad48/wordcloud-from-tags.webp 1600w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/6b221814408fff0db1c489870df79575/772e8/wordcloud-from-tags.png 200w,\n/static/6b221814408fff0db1c489870df79575/e17e5/wordcloud-from-tags.png 400w,\n/static/6b221814408fff0db1c489870df79575/5a190/wordcloud-from-tags.png 800w,\n/static/6b221814408fff0db1c489870df79575/c1b63/wordcloud-from-tags.png 1200w,\n/static/6b221814408fff0db1c489870df79575/29007/wordcloud-from-tags.png 1600w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/6b221814408fff0db1c489870df79575/5a190/wordcloud-from-tags.png\"\n            alt=\"wordcloud from tags\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<br/></p>\n<h2 id=\"処理概要\" style=\"position:relative;\"><a href=\"#%E5%87%A6%E7%90%86%E6%A6%82%E8%A6%81\" aria-label=\"処理概要 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>処理概要</h2>\n<p>Gatsbyを使う場合、画面に必要なデータはビルド時に生成するのがベーシックなやり方です。\nそのためSVG生成は、表示時のReactコンポーネントではなくビルド時の処理（gatsby-node.js）にて行いました。\nビルドはNode.jsの世界ですから、前回記事の<a href=\"https://github.com/Takumon/playbox2019/blob/master/node-kuromoji-d3cloud-sample/index.js\">Node.jsでWordCloudのSVG画像を出力するサンプル</a>が、ほぼそのまま使えるわけです。サンプルと、Gatsbyビルド処理のお作法（gatsby-node.jsの書き方）を考慮して以下のような手順でSVG画像のデータを生成します。</p>\n<ul>\n<li>\n<p>記事全文のWordCloud生成</p>\n<ul>\n<li>記事全文を取得 ☚Gatsbyビルド処理のお作法</li>\n<li>記事全文をインプットにkuromoji.jsで形態素解析</li>\n<li>解析結果をインプットにD3-Cloudでフォーマット</li>\n<li>解析結果をインプットにd3.jsでSVG文字列生成</li>\n<li>Gatsbyページ生成時にContextのプロパティとして渡す ☚Gatsbyビルド処理のお作法</li>\n</ul>\n</li>\n<li>\n<p>記事全タグのWordCloud生成</p>\n<ul>\n<li>記事全タグを取得 ☚Gatsbyビルド処理のお作法</li>\n<li>記事全タグをインプットにタグ出現回数を算出</li>\n<li>解析結果をインプットにD3-Cloudでフォーマット</li>\n<li>解析結果をインプットにd3.jsでSVG文字列生成</li>\n<li>Gatsbyページ生成時にContextのプロパティとして渡す ☚Gatsbyビルド処理のお作法</li>\n</ul>\n</li>\n</ul>\n<p>そして表示時にコンポーネントでSVGデータを取得し画面に表示します。</p>\n<h2 id=\"処理のチューニングポイント\" style=\"position:relative;\"><a href=\"#%E5%87%A6%E7%90%86%E3%81%AE%E3%83%81%E3%83%A5%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88\" aria-label=\"処理のチューニングポイント permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>処理のチューニングポイント</h2>\n<p>WordCloudの品質を上げるために以下のようなチューニングを実施しました。</p>\n<ul>\n<li>「Gatsby」[gatsby」などは同じ単語とみなしてカウントしています。\n<ul>\n<li>文章中で前後文脈によって大文字小文字の差があるものは、同じ単語としてカウントしています。</li>\n<li>最終的にWordCloudに表示する単語は一番大文字の数が多い単語（「Gatsby」[gatsby」なら「Gatsby」）を採用するようにしました。</li>\n</ul>\n</li>\n<li>記事全文は、マークダウンではなくHTMLをインプットにして、HTMLタグを除外、さらにpreタグは中身ごと除外してから形態素解析のインプットとして渡しています。\n<ul>\n<li>マークダウンはリンク、スタイルなどメタ情報が多いため、いったんHTMLに変換したものからHTMLタグを抜くことで純粋な文書だけを抽出しています。</li>\n<li>またソースコードには同じような表現が多く含まれ、WordCloudの対象にするにはノイズが大きく、大事な単語であればソースコード外の文章中に出てくるという前提のもと、ソースコードはすべて除外しています</li>\n<li>「時」「場合」など言い回しとして何度も出てくる単語はWordCloudの情報にしても意味がないので除外しています。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"処理詳細実装\" style=\"position:relative;\"><a href=\"#%E5%87%A6%E7%90%86%E8%A9%B3%E7%B4%B0%E5%AE%9F%E8%A3%85\" aria-label=\"処理詳細実装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>処理詳細（実装）</h2>\n<p>ちょっと長いですが、\nソースコード中のコメントにて詳細を説明します。</p>\n<div class=\"gatsby-code-title\">gatsby-node.jsからWordCloud生成処理抜粋</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">/** HTML形式の記事本文からHTMLタグを削除するために使う */</span>\n<span class=\"token keyword\">const</span> striptags <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'striptags'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/** 仮想DOM d3.js D3-CloudはDOMがある前提なのでNode.js実行時でも正常動作するように仮想Canvasを使う */</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createCanvas <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'canvas'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/** 仮想DOM d3.js D3-CloudはDOMがある前提なのでNode.js実行時でも正常動作するように仮想DOMを使う */</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">JSDOM</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'jsdom'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/** 形態素解析のために使う */</span>\n<span class=\"token keyword\">const</span> kuromoji <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'kuromoji'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/** WordCloudのSVG文字列作成用 */</span>\n<span class=\"token keyword\">const</span> d3 <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d3'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/** WordCloudのSVG文字列作成用 */</span>\n<span class=\"token keyword\">const</span> cloud <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d3-cloud'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/** createPageにてWordCloud生成処理を実装する */</span>\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">createPages</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> graphql<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> createPage <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">/** (略)ページコンポーネント呼び出し */</span>\n\n    <span class=\"token function\">graphql</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/** (略)記事情報呼び出しクエリ */</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n      <span class=\"token comment\">/** (略)もろもろのページ作成 */</span>\n\n\n      <span class=\"token comment\">// WordCloud用データ加工処理</span>\n\n      <span class=\"token comment\">/** (略)resultから記事全文の配列(allPostHtmlTexts)を取得する処理 */</span>\n\n      <span class=\"token comment\">// 記事全文文字列取得</span>\n      <span class=\"token keyword\">const</span> allPostTexts <span class=\"token operator\">=</span> allPostHtmlTexts\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">allHtmlTexts</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// HTML文字列からタグを除外</span>\n          <span class=\"token comment\">// ただしpreタグは、中身をWordCloud解析対象外とするためここではあえて残している</span>\n          <span class=\"token keyword\">const</span> stripedAllText <span class=\"token operator\">=</span> <span class=\"token function\">striptags</span><span class=\"token punctuation\">(</span>allHtmlTexts<span class=\"token punctuation\">,</span> <span class=\"token string\">'&lt;pre>'</span><span class=\"token punctuation\">)</span>\n\n          <span class=\"token comment\">// そのためpreタグとその中身を除外する。</span>\n          <span class=\"token comment\">// preタグの中見はソースコード。</span>\n          <span class=\"token comment\">// キーワードはソースコード外の文章中に記述していることを想定して</span>\n          <span class=\"token comment\">// WordCloudの対象から外す。</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">&lt;pre[\\s\\S]+?>[\\s\\S]+?&lt;\\/pre></span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// 改行でつなぐ</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span>\n      \n\n      <span class=\"token comment\">/** (略)resultから記事全タグの配列(allPostTags)を取得する処理 */</span>\n\n      <span class=\"token comment\">// 記事タグ取得</span>\n      <span class=\"token keyword\">const</span> tagDatas <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n      <span class=\"token comment\">// 記事全タグ情報からどのタグが何回出現するか算出</span>\n      allPostTags<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">tags</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        tags<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">t</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n          <span class=\"token keyword\">const</span> targetData <span class=\"token operator\">=</span> tagDatas<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> data<span class=\"token punctuation\">.</span>text <span class=\"token operator\">===</span> t<span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>targetData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            targetData<span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> targetData<span class=\"token punctuation\">.</span>size <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            tagDatas<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> t<span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">size</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\n      <span class=\"token comment\">// タグ出現回数をインプットにWordCloud生成</span>\n      <span class=\"token comment\">// タグ情報の場合形態素解析せずとも単語ごとの出現回数が算出できるので</span>\n      <span class=\"token comment\">// 形態素解析はスキップしている</span>\n      <span class=\"token function\">createWordCloud</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">words</span><span class=\"token operator\">:</span> tagDatas<span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">w</span><span class=\"token operator\">:</span> <span class=\"token number\">1200</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">h</span><span class=\"token operator\">:</span> <span class=\"token number\">630</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">fontSizePow</span><span class=\"token operator\">:</span> <span class=\"token number\">0.8</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">fontSizeZoom</span><span class=\"token operator\">:</span> <span class=\"token number\">18</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">padding</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">tagSvg</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// タグをインプットにしたSVGが出来上がる</span>\n\n        <span class=\"token comment\">// 記事全文文字列をインプットに単語出現回数を算出</span>\n        <span class=\"token function\">createWordCount</span><span class=\"token punctuation\">(</span>alltext<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n            <span class=\"token comment\">// 記事全文の単語出現回数をインプットにWordCloud生成</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">createWordCloud</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              <span class=\"token literal-property property\">words</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">w</span><span class=\"token operator\">:</span> <span class=\"token number\">1200</span><span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">h</span><span class=\"token operator\">:</span> <span class=\"token number\">630</span><span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">fontSizePow</span><span class=\"token operator\">:</span> <span class=\"token number\">0.6</span><span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">fontSizeZoom</span><span class=\"token operator\">:</span> <span class=\"token number\">3.1</span><span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">padding</span><span class=\"token operator\">:</span> <span class=\"token number\">0.2</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">textSvg</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 記事全文をインプットにしたSVGが出来上がる</span>\n\n            <span class=\"token comment\">// ページ生成時にSVGをContextのプロパティとして渡す</span>\n            <span class=\"token function\">createPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/map/'</span><span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">component</span><span class=\"token operator\">:</span> postRelationMapPage<span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">context</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                allPostRelations<span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">wordCloudText</span> <span class=\"token operator\">:</span> textSvg<span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">wordCloudTag</span><span class=\"token operator\">:</span> tagSvg<span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n            <span class=\"token comment\">// すべてのcreatePageを呼び終わったあとにresolveを呼んで処理終了</span>\n            <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * ２つの単語の大文字小文字の違いをカウントする\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">countDiff</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> a\n    <span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">charA<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> charA <span class=\"token operator\">===</span> b<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> a <span class=\"token operator\">+</span> b<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\">/**\n * 指定した文字列を形態素解析して単語ごとの出現回数を返す\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createWordCount</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">text</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// よく出る言い回しでWordCloudから除外したい単語を列挙  </span>\n  <span class=\"token keyword\">const</span> excludeWords <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'指定'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'時'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'追加'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">/** (略)除外したい単語 */</span>\n  <span class=\"token punctuation\">]</span>\n\n\n  <span class=\"token comment\">/** kuromoji.jsにバンドルされている辞書の格納場所 */</span>\n  <span class=\"token keyword\">const</span> <span class=\"token constant\">DIC_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">'node_modules/kuromoji/dict'</span>\n\n  <span class=\"token comment\">/** WordCloudでカウントする品詞（助詞・助動詞などは省く） */</span>\n  <span class=\"token keyword\">const</span> <span class=\"token constant\">TARGET_POS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'名詞'</span><span class=\"token punctuation\">]</span>\n\n  <span class=\"token comment\">/** kuromoji.jsで該当プロパティの値が存在しない場合に設定されている値 */</span>\n  <span class=\"token keyword\">const</span> <span class=\"token constant\">NO_CONTENT</span> <span class=\"token operator\">=</span> <span class=\"token string\">'*'</span>\n\n  <span class=\"token comment\">// kuromoji.jsで形態素解析</span>\n  <span class=\"token comment\">// 単語ごとの出現回数を出力</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n    kuromoji<span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">dicPath</span><span class=\"token operator\">:</span> <span class=\"token constant\">DIC_URL</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> tokenizer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">// 単語ごとの出現回数を出力</span>\n      <span class=\"token keyword\">const</span> words <span class=\"token operator\">=</span> tokenizer<span class=\"token punctuation\">.</span><span class=\"token function\">tokenize</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">t</span> <span class=\"token operator\">=></span> <span class=\"token constant\">TARGET_POS</span><span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span>pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">t</span> <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span>basic_form <span class=\"token operator\">===</span> <span class=\"token constant\">NO_CONTENT</span> <span class=\"token operator\">?</span> t<span class=\"token punctuation\">.</span>surface_form <span class=\"token operator\">:</span> t<span class=\"token punctuation\">.</span>basic_form<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token punctuation\">,</span> text</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 大文字と小文字を区別せず出現回数をカウントする</span>\n          <span class=\"token keyword\">const</span> upperText <span class=\"token operator\">=</span> text<span class=\"token punctuation\">.</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>excludeWords<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>upperText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> data\n          <span class=\"token punctuation\">}</span>\n\n          <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> c<span class=\"token punctuation\">.</span>text <span class=\"token operator\">===</span> upperText<span class=\"token punctuation\">)</span>\n\n          <span class=\"token comment\">// 出現回数は大文字小文字を区別しないが、実際の生の単語は後の処理で使うためとっておく</span>\n          <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            target<span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>size <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>target<span class=\"token punctuation\">.</span>rawTexts<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              target<span class=\"token punctuation\">.</span>rawTexts<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            data<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> upperText<span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">rawTexts</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> text <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">size</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token keyword\">return</span> data\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n          <span class=\"token comment\">// 上記処理で保持しておいた生の単語をもとに、一番大文字が多い単語をWordCloudの単語として採用する</span>\n          <span class=\"token comment\">// 例えばGatsbyとgatsbyであればGatsbyを採用</span>\n          <span class=\"token keyword\">const</span> almostSameText <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>rawTexts<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">text</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n                text<span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">diff</span><span class=\"token operator\">:</span> <span class=\"token function\">countDiff</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> a<span class=\"token punctuation\">.</span>diff <span class=\"token operator\">&lt;=</span> b<span class=\"token punctuation\">.</span>diff <span class=\"token operator\">?</span> a <span class=\"token operator\">:</span> b<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 大文字に近いほうを採用する</span>\n            <span class=\"token punctuation\">.</span>text\n          \n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> almostSameText<span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">size</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>words<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * 単語出現回数をもとにWordCloudのSVG文字列を返す\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createWordCloud</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  words<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 単語出現回数</span>\n  w<span class=\"token punctuation\">,</span> <span class=\"token comment\">// SVGの幅(単位px)</span>\n  h<span class=\"token punctuation\">,</span> <span class=\"token comment\">// SVGの高さ(単位px)</span>\n  fontSizePow<span class=\"token punctuation\">,</span> <span class=\"token comment\">// WordCloudの文字の大きさの比率調整用係数</span>\n  fontSizeZoom<span class=\"token punctuation\">,</span> <span class=\"token comment\">// WordCloudの文字の大きさの係数</span>\n  padding<span class=\"token punctuation\">,</span> <span class=\"token comment\">// WordCloudの文字間の隙間</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// D3-Cloudによる解析</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">cloud</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>w<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">canvas</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">createCanvas</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">words</span><span class=\"token punctuation\">(</span>words<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">word</span> <span class=\"token operator\">=></span> word<span class=\"token punctuation\">.</span>size <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">===</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token number\">90</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 出現回数に応じて縦か横向きに表示</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">fontWeight</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">word</span> <span class=\"token operator\">=></span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>word<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> fontSizePow<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> fontSizeZoom<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">fontSize</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">word</span> <span class=\"token operator\">=></span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>word<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> fontSizePow<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> fontSizeZoom<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">font</span><span class=\"token punctuation\">(</span><span class=\"token string\">'meiryo'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">padding</span><span class=\"token punctuation\">(</span>padding<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">wordsForCloud</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>wordsForCloud<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// d3.jsによる解析</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">wordsForCloud</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/** 仮想DOM */</span>\n      <span class=\"token keyword\">const</span> document <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSDOM</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;body>&lt;/body></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>window<span class=\"token punctuation\">.</span>document\n\n      d3<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'svg'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'class'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ui fluid image'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'viewBox'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">0 0 </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>w<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>h<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'width'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'100%'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'100%'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'g'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transform'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">translate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>w<span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">,</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>h<span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>wordsForCloud<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">enter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'font-size'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>size<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'font-family'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> d<span class=\"token punctuation\">.</span>font<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transform'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">translate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>x<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>y<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)rotate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>rotate<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fill'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> d3<span class=\"token punctuation\">.</span>schemeCategory10<span class=\"token punctuation\">[</span>i <span class=\"token operator\">%</span> <span class=\"token number\">10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text-anchor'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'middle'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> d<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n      \n      <span class=\"token comment\">// 最終的にSVGの文字列を返す</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>自分のブログにWordCloudを導入したいと思い立ち、WordCloudについて3回にわたりブログを書いてきましたが、各種ライブラリのおかげで、すんなりと導入できました。\n人に自分のブログを紹介するときのネタとしてはとても効果的だと思います。<br/>\nなお形態素解析やWordCloud生成は重い処理なので、ビルドに時間がかかるようになってしまいますが、画面表示に関してはパフォーマンスに影響はありません。<br/>\nあと本来であればプラグイン化して配布したいところですが、プラグイン化のためには、まだまだ汎用性を高る必要があって、それは今後の課題です🍅</p>","excerpt":"なにこれ 前回記事ではNode.jsでWordCloudを出力しました。\n今回は、前回のサンプルをベースに自分のブログ（Gatsby製のブログ）にWordCloudを取り入れてみたので、その時の実装方法のメモです。 ※ソースコードは以下です。\nhttps://github.com…","frontmatter":{"slug":"/wordcloud-in-gatsby-blog","title":"Gatsby製ブログにWordCloudを導入","date":"2019-05-11T17:00:00.000+09:00","tags":["Gatsby","kuromoji.js","d3.js","d3Cloud","形態素解析","データ可視化","WordCloud"],"keywords":["Gatsby"],"thumbnail":"thumbnail/2019/05/wordcloud-in-gatsby-blog.png","category":null}},{"html":"<h2 id=\"なにこれ\" style=\"position:relative;\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-label=\"なにこれ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p><a href=\"/wordcloud-with-kuromoji-d3cloud-react\">前回記事</a>ではReactでWordCloudを出力しました。しかし実際は、過去大量データから出力するようなツールとして使えたほうが便利です。\nそこで<a href=\"https://github.com/Takumon/playbox2019/blob/master/react-kuromoji-sample/src/App.js\">前回のサンプル</a>をベースにNode.jsでWordCloudのSVGファイルを出力するサンプルを作成しました。\n今回はサンプルの実装方法をポイントと合わせてご紹介します。</p>\n<p>※サンプルは以下に置いております。\n<a href=\"https://github.com/Takumon/playbox2019/blob/master/node-kuromoji-d3cloud-sample/index.js\">https://github.com/Takumon/playbox2019/blob/master/node-kuromoji-d3cloud-sample/index.js</a></p>\n<p>この記事は、<a href=\"https://gw-advent.9wick.com/calendars/9\">challenge-every-month全員でアウトプット芸人 Advent Calendar</a> 9日目の記事です。前日の記事は、<a href=\"https://twitter.com/kojirock5260\">@kojirock5260</a>さんの記事でした。</p>\n<iframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fkojirooooocks.hatenablog.com%2Fentry%2F2019%2F05%2F04%2F163742\" style=\"border: 0; width: 100%; height: 190px;\" allowfullscreen scrolling=\"no\" allow=\"autoplay; encrypted-media\"></iframe>\n<h2 id=\"処理手順\" style=\"position:relative;\"><a href=\"#%E5%87%A6%E7%90%86%E6%89%8B%E9%A0%86\" aria-label=\"処理手順 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>処理手順</h2>\n<p>以下4ステップです。</p>\n<ol>\n<li>kuromoji.jsで文章を解析して単語出現回数をデータ化</li>\n<li>D3-Cloudで上記データに以下情報追加\n<ol>\n<li>フォントの大きさ</li>\n<li>フォントの回転位置</li>\n<li>フォントの種類</li>\n<li>表示位置</li>\n</ol>\n</li>\n<li>d3.jsで配色を決定しSVGを<strong>仮想DOM</strong>に描画</li>\n<li>SVGをファイル出力</li>\n</ol>\n<h2 id=\"実装のポイント\" style=\"position:relative;\"><a href=\"#%E5%AE%9F%E8%A3%85%E3%81%AE%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88\" aria-label=\"実装のポイント permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実装のポイント</h2>\n<h3 id=\"1-d3-cloud--canvasだけでは不十分なのでd3jsを使う\" style=\"position:relative;\"><a href=\"#1-d3-cloud--canvas%E3%81%A0%E3%81%91%E3%81%A7%E3%81%AF%E4%B8%8D%E5%8D%81%E5%88%86%E3%81%AA%E3%81%AE%E3%81%A7d3js%E3%82%92%E4%BD%BF%E3%81%86\" aria-label=\"1 d3 cloud  canvasだけでは不十分なのでd3jsを使う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. D3-Cloud + Canvasだけでは不十分なのでd3.jsを使う</h3>\n<p>最初は、D3-CloudでCanvasを使えるので、<a href=\"https://github.com/Automattic/node-canvas\">node-canvas</a>を使えばNode.jsでも画像を生成できるのでは？と考えたのですが、やってみるとうまくいきません。以下のような画像が出力されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4538ff67e1815ab50581a395af5a3b88/5a3c9/wordcloud-by-canvas.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABcRAAAXEQHKJvM/AAACWUlEQVR42k1STU/bQBD1//8DVVWp4siNA1GtVM2BA+IAAQJyQrCTTZzYcbJe25sQgnGWV73dumBpvLPz8ebNzHqi3/9enJ721knySw6Hvry48GWS+PLkxJfdri+XS19mmS/nc1/e3fny7MyXk4kvN5v/duYWj49/xkHw09OLRYCrK6AsDfZ7QAigroF+H8gy4HgE8hy4vgYOB2C9BpoGeH9352YDvLwY9HpQURR6VZ4/AoAxpjH7vTHHo7EfTa20H/XDwZi6NqYoXGyWGZMkDZZL5Gk69vTlZYDBgNUNhkNWA7QGlIK9SwnMZsDTEzAew8bSdnPjYpZL+mx3SuvQ01oHZIjj0Vg+/NLUtb5YAFHkgJnI1tsYlwPsdrZB/pRSoaejKLDz0NrYGTGhZUidjDmrsnSAjKWvqoDt1s2buR8fUEURelqIwFbabg3e3lxgkrjhM5ktTqfuTjYuFnh9dWAEl/ILw+EwsM6qMigKx46gPJlIIRgZUufmWZg6R0M7c+saKklCT9/fO4arlcFk4gZPRpzZfP7ZWgsQhq71tm0+td3OAUoZeno0cjOMY2NBCErhUuLYtcmTgO1WuSxunoV5JonBagU1Gv1jyMf5/GxsAFkxyQWSuQMkCKX100edPpIpS6jxOPS2Qgws9TStIWWDNG2wWPChNuCDpWRZY3153qAonE6bUg2qqkFZ1uxAxfHI03HsWuam2BIXQ2ER3lsbh09pZ9fenW5fiJrNQi++vf32IsTvMorOq8mkUwnRqabTT+GddspXW3vO551SiPPdbNYVDw8//gJnIRX3lkjjHwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4538ff67e1815ab50581a395af5a3b88/ba381/wordcloud-by-canvas.webp 200w,\n/static/4538ff67e1815ab50581a395af5a3b88/7f61c/wordcloud-by-canvas.webp 400w,\n/static/4538ff67e1815ab50581a395af5a3b88/d00b9/wordcloud-by-canvas.webp 800w,\n/static/4538ff67e1815ab50581a395af5a3b88/e28de/wordcloud-by-canvas.webp 1169w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4538ff67e1815ab50581a395af5a3b88/772e8/wordcloud-by-canvas.png 200w,\n/static/4538ff67e1815ab50581a395af5a3b88/e17e5/wordcloud-by-canvas.png 400w,\n/static/4538ff67e1815ab50581a395af5a3b88/5a190/wordcloud-by-canvas.png 800w,\n/static/4538ff67e1815ab50581a395af5a3b88/5a3c9/wordcloud-by-canvas.png 1169w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4538ff67e1815ab50581a395af5a3b88/5a190/wordcloud-by-canvas.png\"\n            alt=\"wordcloud by canvas\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>そのためD3-Cloud + Canvasだけの組み合わせはあきらめて、\n<a href=\"https://github.com/Yoctol/react-d3-cloud\">react-d3-cloud</a>の内部実装と同じようにd3.jsを使ってSVGを描画して、そこからファイル出力処理するようにしました。</p>\n<h3 id=\"2-domエミュレート用にnode-canvasとjsdomを使う\" style=\"position:relative;\"><a href=\"#2-dom%E3%82%A8%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%83%88%E7%94%A8%E3%81%ABnode-canvas%E3%81%A8jsdom%E3%82%92%E4%BD%BF%E3%81%86\" aria-label=\"2 domエミュレート用にnode canvasとjsdomを使う permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. DOMエミュレート用にnode-canvasとjsdomを使う</h3>\n<p><a href=\"https://github.com/d3/d3\">d3.js</a>は、ブラウザ上での動作を前提としているためDOMが必要です。Node.jsでDOMをエミュレートするために<a href=\"https://github.com/jsdom/jsdom\">jsdom</a>を使いました。<br/>\n<a href=\"https://github.com/jasondavies/d3-cloud\">D3-Cloud</a>も同様にCanvasの指定が必須です。\nそのためCanvasをエミュレートする<a href=\"https://github.com/Automattic/node-canvas\">node-canvas</a>を使いました。</p>\n<h2 id=\"実装\" style=\"position:relative;\"><a href=\"#%E5%AE%9F%E8%A3%85\" aria-label=\"実装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実装</h2>\n<p>ポイントを踏まえたうえで4ステップごとに実装方法を説明します。</p>\n<h3 id=\"1-kuromojijsで文章を解析して単語出現回数をデータ化\" style=\"position:relative;\"><a href=\"#1-kuromojijs%E3%81%A7%E6%96%87%E7%AB%A0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%A6%E5%8D%98%E8%AA%9E%E5%87%BA%E7%8F%BE%E5%9B%9E%E6%95%B0%E3%82%92%E3%83%87%E3%83%BC%E3%82%BF%E5%8C%96\" aria-label=\"1 kuromojijsで文章を解析して単語出現回数をデータ化 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. kuromoji.jsで文章を解析して単語出現回数をデータ化</h3>\n<p>kuromoji.jsによるデータ加工については<a href=\"/wordcloud-with-kuromoji-d3cloud-react#1-%E6%96%87%E7%AB%A0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%A6%E5%8D%98%E8%AA%9E%E5%87%BA%E7%8F%BE%E5%9B%9E%E6%95%B0%E3%82%92%E3%83%87%E3%83%BC%E3%82%BF%E5%8C%96-1\">前回記事のReactアプリ</a>と同様です。\n今回はブラウザではなくNode.jsで動かすのでkuromoji.jsの辞書はnode_modules配下から移動する必要はありません。</p>\n<div class=\"gatsby-code-title\">kuromoji.jsによる解析処理</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> kuromoji <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'kuromoji'</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\">// インプットとなる文章(長文につき一部省略)</span>\n<span class=\"token keyword\">const</span> text <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\nそこも場合もうその病気らに対して旨の時がしんませ。\n単に事実に使用方はどうかその応用たないでもが思いてならないがも発展思いうべきて、\nあいにくにもなるだなですた。\n・・・\n</span><span class=\"token template-punctuation string\">`</span></span>\n\n<span class=\"token comment\">// kuromoji.jsにバンドルされている辞書のフォルダパス</span>\n<span class=\"token comment\">// kuromoji.jsは形態素解析用関数を生成する際に辞書を読み込む</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">DIC_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">'node_modules/kuromoji/dict'</span>\n\n<span class=\"token comment\">// WordCloudの情報として抽出する品詞（助詞、助動詞などは意味がないので拾わない）</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">TARGET_POS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'名詞'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'動詞'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'形容詞'</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">// kuromoji.jsの解析結果の値で特に値がない場合は以下の文字が設定される</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">NO_CONTENT</span> <span class=\"token operator\">=</span> <span class=\"token string\">'*'</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// kuromoji.jsによる解析処理</span>\n  <span class=\"token keyword\">const</span> words <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 辞書を読み混んでトークナイザー（形態素解析するための関数）を生成</span>\n    kuromoji<span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">dicPath</span><span class=\"token operator\">:</span> <span class=\"token constant\">DIC_URL</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> tokenizer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">// テキストを引数にして形態素解析</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>tokenizer<span class=\"token punctuation\">.</span><span class=\"token function\">tokenize</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// pos（品詞）を参照し、'名詞', '動詞', '形容詞'のみを抽出</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">t</span> <span class=\"token operator\">=></span> <span class=\"token constant\">TARGET_POS</span><span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span>pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// 単語を抽出(basic_formかsurface_formに単語が存在する)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">t</span> <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span>basic_form <span class=\"token operator\">===</span> <span class=\"token constant\">NO_CONTENT</span> <span class=\"token operator\">?</span> t<span class=\"token punctuation\">.</span>surface_form <span class=\"token operator\">:</span> t<span class=\"token punctuation\">.</span>basic_form<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// [{text: 単語, size: 出現回数}]の形にReduce</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token punctuation\">,</span> text</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> c<span class=\"token punctuation\">.</span>text <span class=\"token operator\">===</span> text<span class=\"token punctuation\">)</span>\n\n          <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            target<span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>size <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            data<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              text<span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">size</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token keyword\">return</span> data\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\n  <span class=\"token comment\">// D3-Cloudによる解析処理</span>\n  <span class=\"token comment\">// (略)</span>\n\n  <span class=\"token comment\">// d3.jsによる描画処理</span>\n  <span class=\"token comment\">// (略)</span>\n\n  <span class=\"token comment\">// SVGファイル出力処理</span>\n  <span class=\"token comment\">// (略)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<p>これで以下のような情報が得られます。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token punctuation\">[</span> \n  <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">'相違'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 単語</span>\n    <span class=\"token literal-property property\">size</span><span class=\"token operator\">:</span> <span class=\"token number\">19</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 出現回数</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<h3 id=\"2-d3-cloudで上記データに以下情報追加\" style=\"position:relative;\"><a href=\"#2-d3-cloud%E3%81%A7%E4%B8%8A%E8%A8%98%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E4%BB%A5%E4%B8%8B%E6%83%85%E5%A0%B1%E8%BF%BD%E5%8A%A0\" aria-label=\"2 d3 cloudで上記データに以下情報追加 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. D3-Cloudで上記データに以下情報追加</h3>\n<p>D3-Cloudでは解析情報に以下を追加するだけです。</p>\n<ul>\n<li>フォントの回転位置 ☚自分で定義</li>\n<li>フォントの重み ☚自分で定義</li>\n<li>フォントの大きさ ☚自分で定義</li>\n<li>フォントの種類 ☚自分で定義</li>\n<li>表示位置 ☚D3-Cloudが定義してくれる</li>\n</ul>\n<p>なおD3-CloudはbodyタグかCanvasが必須なので、今回は<a href=\"https://github.com/Automattic/node-canvas\">node-canvas</a>を使います。</p>\n<div class=\"gatsby-code-title\">D3-Cloudによる解析処理</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> cloud <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d3-cloud'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// Node.jsでCanvasをエミュレートするためnode-canvasを使う</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createCanvas <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'canvas'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Canvasの幅(px)</span>\n<span class=\"token keyword\">const</span> w <span class=\"token operator\">=</span> <span class=\"token number\">1600</span>\n\n<span class=\"token comment\">// Canvasの高さ(px)</span>\n<span class=\"token keyword\">const</span> h <span class=\"token operator\">=</span> <span class=\"token number\">1000</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// kuromoji.jsによる解析処理</span>\n  <span class=\"token comment\">// (略)</span>\n\n  <span class=\"token comment\">// D3-Cloudによる解析処理</span>\n  <span class=\"token comment\">// D3-Cloudの解析によってwordsForCloudには</span>\n  <span class=\"token comment\">// 出現回数の他にフォントの回転位置、大きさ、重み、種類が追加された状態になる</span>\n  <span class=\"token keyword\">const</span> wordsForCloud <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">cloud</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>w<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// node-canvasを指定する(エラーを防ぐため)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">canvas</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">createCanvas</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// kuromoji.jsの解析結果を指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">words</span><span class=\"token punctuation\">(</span>words<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// フォントの回転位置を指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">word</span> <span class=\"token operator\">=></span> word<span class=\"token punctuation\">.</span>size <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">===</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token number\">90</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// フォントの重みを指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">fontWeight</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">word</span> <span class=\"token operator\">=></span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>word<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> <span class=\"token number\">1.3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// フォントの大きさを指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">fontSize</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">word</span> <span class=\"token operator\">=></span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>word<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> <span class=\"token number\">1.3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// フォントの種類を指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">font</span><span class=\"token punctuation\">(</span><span class=\"token string\">'meiryo'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 加工終了時のイベント登録、解析結果をd3.jsでの描画に引き継ぐ</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">words</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>words<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 解析開始</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// d3.jsによる描画処理</span>\n  <span class=\"token comment\">// (略)</span>\n\n  <span class=\"token comment\">// SVGファイル出力処理</span>\n  <span class=\"token comment\">// (略)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<p>これで以下のような情報が得られます。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span> \n    <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">'相違'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">size</span><span class=\"token operator\">:</span> <span class=\"token number\">19</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// D3-Cloudによって追加された情報</span>\n    <span class=\"token literal-property property\">font</span><span class=\"token operator\">:</span> <span class=\"token string\">'meiryo'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">style</span><span class=\"token operator\">:</span> <span class=\"token string\">'normal'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">weight</span><span class=\"token operator\">:</span> <span class=\"token number\">19.952623149688797</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">rotate</span><span class=\"token operator\">:</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">padding</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">width</span><span class=\"token operator\">:</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">height</span><span class=\"token operator\">:</span> <span class=\"token number\">59</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">xoff</span><span class=\"token operator\">:</span> <span class=\"token number\">192</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">yoff</span><span class=\"token operator\">:</span> <span class=\"token number\">957</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">x1</span><span class=\"token operator\">:</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">y1</span><span class=\"token operator\">:</span> <span class=\"token number\">28</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">x0</span><span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">y0</span><span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">hasText</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">199</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> <span class=\"token number\">294</span> \n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<h3 id=\"3-d3jsで配色を決定しsvgを仮想domに描画\" style=\"position:relative;\"><a href=\"#3-d3js%E3%81%A7%E9%85%8D%E8%89%B2%E3%82%92%E6%B1%BA%E5%AE%9A%E3%81%97svg%E3%82%92%E4%BB%AE%E6%83%B3dom%E3%81%AB%E6%8F%8F%E7%94%BB\" aria-label=\"3 d3jsで配色を決定しsvgを仮想domに描画 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. d3.jsで配色を決定しSVGを<strong>仮想DOM</strong>に描画</h3>\n<p>D3-Cloudの解析情報に文字色や配置情報を追加してSVGを仮想DOM上に描画します。\n仮想DOMは<a href=\"https://github.com/jsdom/jsdom\">jsdom</a>を使って生成します。<br/>\nフォント色のテーマは<code class=\"language-text\">schemeCategory10</code>を使いました。他にもいろいろテーマがあるようです。<br/>\n参考：<a href=\"https://wizardace.com/d3v5-scale-chromatic/\">D3.js v5 カラーテーマまとめ (d3-scale-chromatic) – データビジュアライゼーション・ラボ</a></p>\n<div class=\"gatsby-code-title\">d3.jsによるSVG描画処理</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> d3 <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d3'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">JSDOM</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"jsdom\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 仮想documentオブジェクトを生成</span>\n<span class=\"token keyword\">const</span> document <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSDOM</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;body>&lt;/body></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>window<span class=\"token punctuation\">.</span>document\n\n<span class=\"token comment\">// WordCloud描画領域の幅(px) ※Canvasのやつを使いまわし</span>\n<span class=\"token keyword\">const</span> w <span class=\"token operator\">=</span> <span class=\"token number\">1600</span>\n\n<span class=\"token comment\">// WordCloud描画領域の高さ(px) ※Canvasのやつを使いまわし</span>\n<span class=\"token keyword\">const</span> h <span class=\"token operator\">=</span> <span class=\"token number\">1000</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// kuromoji.jsによる形態素解析</span>\n  <span class=\"token comment\">// (略)</span>\n\n  <span class=\"token comment\">// D3-Cloudによる解析処理</span>\n  <span class=\"token comment\">// (略)</span>\n\n  <span class=\"token comment\">// d3.jsによるSVG描画処理</span>\n  <span class=\"token comment\">// 仮想DOMのbodyタグを指定</span>\n  d3<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// SVG形式で仮想DOMに描画</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'svg'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// SVGのプロパティもろもろ指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'class'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ui fluid image'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'viewBox'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">0 0 </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>w<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>h<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'width'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'100%'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'100%'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// SVGのグループ要素追加して</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'g'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// SVGを中央寄せ</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transform'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">translate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>w<span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">,</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>h<span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// テキスト要素にD3-Cloudによる解析結果を追加</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>wordsForCloud<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 領域を新規作成し、テキスト要素追加</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">enter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// フォントの大きさは解析結果通りに指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'font-size'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>size<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// フォントの種類は解析結果通りに指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'font-family'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> d<span class=\"token punctuation\">.</span>font<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// フォントの配色は、schemeCategory10を指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fill'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> d3<span class=\"token punctuation\">.</span>schemeCategory10<span class=\"token punctuation\">[</span>i <span class=\"token operator\">%</span> <span class=\"token number\">10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// テキストの真ん中を表示位置のポイントに指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text-anchor'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'middle'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 位置と回転位置は解析結果通りに指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transform'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">translate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>x<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>y<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)rotate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>rotate<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 単語は解析結果通りに指定</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> d<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// SVGファイル出力処理</span>\n    <span class=\"token comment\">// (略)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<h3 id=\"4-svgをファイル出力\" style=\"position:relative;\"><a href=\"#4-svg%E3%82%92%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E5%87%BA%E5%8A%9B\" aria-label=\"4 svgをファイル出力 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. SVGをファイル出力</h3>\n<p>仮想DOMに描画したSVGをファイル出力します。</p>\n<div class=\"gatsby-code-title\">d3.jsによるSVG描画処理</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// kuromoji.jsによる形態素解析</span>\n  <span class=\"token comment\">// (略)</span>\n\n  <span class=\"token comment\">// D3-Cloudによる解析処理</span>\n  <span class=\"token comment\">// (略)</span>\n\n  <span class=\"token comment\">// d3.jsによるSVG描画処理</span>\n  <span class=\"token comment\">// (略)</span>\n\n  <span class=\"token comment\">// 仮想DOMに描画されたSVGをファイル出力</span>\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'wordcloud.svg'</span><span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<p>すると以下のようなファイルが出力されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"html:svgファイルの中身\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-html:svgファイルの中身 line-numbers\"><code class=\"language-html:svgファイルの中身\">&lt;svg class=&quot;ui fluid image&quot; viewBox=&quot;0 0 1600 1000&quot; width=&quot;100%&quot; height=&quot;100%&quot;&gt;\n  &lt;g transform=&quot;translate(800,500)&quot;&gt;\n    &lt;text style=&quot;font-size: 466px; font-family: meiryo; fill: #1f77b4;&quot; transform=&quot;translate(48, 35)rotate(0)&quot; text-anchor=&quot;middle&quot;&gt;ある&lt;/text&gt;\n    &lt;text style=&quot;font-size: 269px; font-family: meiryo; fill: #ff7f0e;&quot; transform=&quot;translate(460, 15)rotate(90)&quot; text-anchor=&quot;middle&quot;&gt;よう&lt;/text&gt;&lt;text style=&quot;font-size: 245px; font-family: meiryo; fill: #2ca02c;&quot; transform=&quot;translate(-263, -290)rotate(0)&quot; text-anchor=&quot;middle&quot;&gt;云う&lt;/text&gt;\n    &lt;text style=&quot;font-size: 191px; font-family: meiryo; fill: #d62728;&quot; transform=&quot;translate(-265, 193)rotate(0)&quot; text-anchor=&quot;middle&quot;&gt;それ&lt;/text&gt;\n   ・\n   ・\n   ・\n  &lt;/g&gt;\n&lt;/svg&gt;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<p>描画すると以下のようになります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5e4aed803fecc163a2ec605e3c7848a6/29007/wordcloud.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABcRAAAXEQHKJvM/AAACnUlEQVR42n2T7U/TUBjF/XP9aPxgNP4DJMYYlJj4xSiJYJCIgCyACBkZgW2srN1Kx9q16/qyDugrbVd2e3vMuiEixpucnHuTk999nif3PvB9n3cc59hxHMa2bca2Bsx47/h+7lHgM4HvMVe+xzi2w1xc2rnyzK2qruueVSqVZw8AgKYpHXvKsiB7u0g5Dmn5EBlJMYhSBAlFcJ0hIXns3sqyLB27JElzEyBNydiGmk692hEdNpq0Wdijqzt1+oW1aLXnUd70KddzaIE16KejLo2TvIgbjabA11Mgza/uD87RaTagnrWwfNjGo8UiXn2tQGcFqN4VzlQVbzdqmN2VkICg21NgGiY0TcsrVBTlzR2gG3qQ5DNctHl8r4p4usLkwOVCBT+6BhbqHTxZOMRSqYWNpg7N1GDoOvT7wMkMZb+Pc5tHtX2BuR0BD+dLcAUWG2UOa2UGH4oneLd1gpagYW79FFZXAORdpBluZjgBTmrMcOwFMJMIjGTiRaGBlZqIn5UWXq6XoXbfoy4fYGaFxfPFItYZC9Q4AS3OgNY+pkAISdHutiz0PAiDALFpIDB0BKYLuW1BbndQFArYldfB9DgsNlfRUXhcihwiq4TRxenfFYIOr0aorCno8RYaZQ09/hz8gQy9IUE2eGwK2zjqMSgbB1gU5rFVXoPbrCOOOxh1tlNgCElWboGjhCDwCJKBhkAUYTVsdFt9hO0BWIXHfv0bjtjPUE0Lx1oZQRKDDkRQcROUXUqReZBU/XfL1wBIrtAksC0SNm0Sqy5JRJeYtUuSqApJTZY4/ZggnWbHihyC6zAZc0SxPXtnhv/+BuNnm+F/685PSZKkGkXRfhRFpYnCiYfT8zAqRclw4lFYGg5vcn/mw/04jk84jnv8Cy/EsfT7rCouAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5e4aed803fecc163a2ec605e3c7848a6/ba381/wordcloud.webp 200w,\n/static/5e4aed803fecc163a2ec605e3c7848a6/7f61c/wordcloud.webp 400w,\n/static/5e4aed803fecc163a2ec605e3c7848a6/d00b9/wordcloud.webp 800w,\n/static/5e4aed803fecc163a2ec605e3c7848a6/92f8c/wordcloud.webp 1200w,\n/static/5e4aed803fecc163a2ec605e3c7848a6/fad48/wordcloud.webp 1600w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5e4aed803fecc163a2ec605e3c7848a6/772e8/wordcloud.png 200w,\n/static/5e4aed803fecc163a2ec605e3c7848a6/e17e5/wordcloud.png 400w,\n/static/5e4aed803fecc163a2ec605e3c7848a6/5a190/wordcloud.png 800w,\n/static/5e4aed803fecc163a2ec605e3c7848a6/c1b63/wordcloud.png 1200w,\n/static/5e4aed803fecc163a2ec605e3c7848a6/29007/wordcloud.png 1600w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5e4aed803fecc163a2ec605e3c7848a6/5a190/wordcloud.png\"\n            alt=\"wordcloud\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>Node.jsでWordCloudのSVGファイルを出力する方法についてご紹介しました。\n今回の実装で、ブラウザ処理はnode-canvasとjsdomを使えばNode.jsでも再現できることがわかったので、いろんな場面で応用できそうです。\n次回は、今回の実装をベースにして自分のブログのWordCloudを生成してみようと思います🍅</p>","excerpt":"なにこれ 前回記事ではReactでWordCloudを出力しました。しかし実際は、過去大量データから出力するようなツールとして使えたほうが便利です。\nそこで前回のサンプルをベースにNode.jsでWordCloudのSVG…","frontmatter":{"slug":"/wordcloud-with-kuromoji-d3cloud-nodejs","title":"Node.js + kuromoji.js + D3-CloudでWordCloudの画像を出力","date":"2019-05-04T18:00:00.000+09:00","tags":["Node.js","kuromoji.js","d3.js","d3Cloud","データ可視化","形態素解析","WordCloud"],"keywords":["WordCloud"],"thumbnail":"thumbnail/2019/05/wordcloud-with-kuromoji-d3cloud-nodejs.png","category":null}},{"html":"<h2 id=\"なにこれ\" style=\"position:relative;\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-label=\"なにこれ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>WordCloudをJSだけで生成したい。Pythonとか使わずにフロントエンドだけでやりたい。というモチベーションで、\n<a href=\"https://github.com/takuyaa/kuromoji.js/\">kuromoji.js</a>と<a href=\"https://github.com/jasondavies/d3-cloud\">D3-Cloud</a>を使って文字列をインプットにWordCloudを描画するReactアプリを作ってみました。今回はそのやり方についてご紹介します。</p>\n<p>※サンプルコードは以下に置いております。\n<a href=\"https://github.com/Takumon/playbox2019/blob/master/react-kuromoji-sample/src/App.js\">https://github.com/Takumon/playbox2019/blob/master/react-kuromoji-sample/src/App.js</a></p>\n<h2 id=\"wordcloudの作り方原理\" style=\"position:relative;\"><a href=\"#wordcloud%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9%E5%8E%9F%E7%90%86\" aria-label=\"wordcloudの作り方原理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WordCloudの作り方（原理）</h2>\n<p>WordCloudは文章をインプットにして画像をアウトプットします。\nその過程は2つに分かれます。</p>\n<h3 id=\"1-文章を解析して単語出現回数をデータ化\" style=\"position:relative;\"><a href=\"#1-%E6%96%87%E7%AB%A0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%A6%E5%8D%98%E8%AA%9E%E5%87%BA%E7%8F%BE%E5%9B%9E%E6%95%B0%E3%82%92%E3%83%87%E3%83%BC%E3%82%BF%E5%8C%96\" aria-label=\"1 文章を解析して単語出現回数をデータ化 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 文章を解析して単語出現回数をデータ化</h3>\n<div class=\"gatsby-code-title\">たとえばこんな文章を...</div>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-txt line-numbers\"><code class=\"language-txt\">そこも場合もうその病気らに対して旨の時がしんませ。単に事実に使用方はどうかその応用たないでもが思いてならないがも発展思いうべきて、あいにくにもなるだなですた。\n差が向いんものは何だか翌日からしきりにんなけれう。もちろんネルソンさんで養成道具一応束縛に致しませ示威この力誰か講演をというご妨害ないますですうば、\n...</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>↓↓</p>\n<div class=\"gatsby-code-title\">単語と出現回数のデータに加工します</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"そこ\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">14</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"場合\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">11</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"うそ\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"病気\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">8</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ら\"</span><span class=\"token punctuation\">,</span>      <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">17</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"旨\"</span><span class=\"token punctuation\">,</span>      <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"時\"</span><span class=\"token punctuation\">,</span>      <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">43</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"しん\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"事実\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"使用\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">6</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"方\"</span><span class=\"token punctuation\">,</span>      <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">41</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"応用\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ない\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">175</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"思う\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">39</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"なる\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">99</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"発展\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">13</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"思い\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"くる\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">8</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"差\"</span><span class=\"token punctuation\">,</span>      <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">4</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token string\">\"向く\"</span><span class=\"token punctuation\">,</span>    <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">6</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n<span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"2-データをもとにイイ感じの画像出力\" style=\"position:relative;\"><a href=\"#2-%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%82%E3%81%A8%E3%81%AB%E3%82%A4%E3%82%A4%E6%84%9F%E3%81%98%E3%81%AE%E7%94%BB%E5%83%8F%E5%87%BA%E5%8A%9B\" aria-label=\"2 データをもとにイイ感じの画像出力 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. データをもとにイイ感じの画像出力</h3>\n<p>単語と出現回数の他に、以下の値を何らかの形で決定します。</p>\n<ul>\n<li>フォントの大きさ</li>\n<li>フォントの回転位置</li>\n<li>フォントの種類</li>\n<li>フォントの色</li>\n<li>表示位置</li>\n</ul>\n<p>大体のWordCloud系ライブラリは出現回数が多い単語を大きく中心に配置し、\nその周りに敷き詰めるように他の単語を配置します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/76191097103de55829c825fc63f9828a/748b0/wordcloud-sample.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 86%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAENElEQVR42kWS624aZwJAedl9kNXuj0p7UdTLrrorbXerNm0um5hkEjtxHGzHEAzmAzw2twGGuQ9zgYEBhst8PlXVH32BI52jU1DV1lcj3epNG29v1lf/FaPRG2G4FRHexWI28sSbW0s8/dQVP37qCuvOEd26JxqfHRENZ8Ib+0KLI9Hzw5uWF/QajcajgmHqypyULNZy4j6rrEW+6ZH5GotsTa07oTxZUjXWZMuQ3OySGWOw75GLDHu+5zjd5G+2MHKcYkGf6K8yEppmtH/d8uV0tpBc/0duP34hN+0nkvI3cq9dyMDey4XWlQf9WnL1SB4u/yYtN5XGXSjb6/W+lO4xbPtlYawbSnIAMZnl35fHdMIMaV3Dsz+QGg6Zcc9D8xlTD9Ig4VD7gYf3f+bQVfA0nZu7iNNZkncOoFtWsaCPB8phmzL3zTx0l0zjDXz8E/LiW1YRyPsy2/4R8zSA1lMeescs5zEbZ8ju7d8piYB/RfP8+WLHyLSKhYFhKqx06Cr5pjlD2iYPNz8ga09YBrBVzzlUvmQXD8CoQflrHkp/Zd8scij/D7Nj0Rkbubt/wHLdYsG2HQVW5EGUr7SE7Sjl4CRgtgmGDk+vNaR2xso3WfgWmVCQv2qrL5m/KpKefsB7+yzHC5jUh8WCaZoK7Jj7Tj4xbQLTpl+tcFep4N0JXjddfrwJSOczVvOIXesW2b5mmy1IL0tsHYefwtPcywK85qRYsF1X4SBZW3a+negsfJ/edZlho0bzwzGLqcl5x+SPRyr/LvV5fNrntl4Dq0rut9mvFljtcs56xcT0igVT0xTSBdHUz23TxxxPGIk6ekvQrVyxXfm8V3X+8rbPu7bJS7X9ayuCB5g7Dqt370gqtXxu6KiiXiwYuq64C4kX+3k4V0nmNlq1QvtTCa9X53l9wk9VCysdUHXO+e72W150n6JGY9SpSmN4zj5K8kOSMLhVi4WxriuTJehOLV8uq0ytK4aNOoPrCvdC8N2lxmIW4I6GHA+Oed75PyeTDzQHFzitGqo7Jj15l3PfQdcnxYJj2wpAuJrl0fIOyyij1auoF2fcHCtMgym98YhZEiPcBo/bj3k9OkEML0lOzhF+Rvzieb6tVKi3mr8D+zM3PzNP6Rq3DD5fcfvxBLVySaLrZNqIj/oZyvANxf4RT+5/5kR/D2qf2dEL0vOLXG42lPq/bfNKAk4a7Rt+Qw5DTTqDoex+FnIWRHL54UzG//in1HqqrHSqsj9syWb3s2z6ujwK13JomjK0f96vWfBp5L0sOE6kQMAu6+W2NSXwbXbpDl/bsl9twbFhFrNZpiyTlF264iGJSTcrqpnE3e85bNQcNqiTXrFw31a/SmKrF3rmjTkciVG3I1xjIjzPFaHjiNgwRZLEYjENhR/FIg5nIg0dETlj4TmuiD1HRNPZjakPeqVG6dEvx/OxlPZOgfsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/76191097103de55829c825fc63f9828a/ba381/wordcloud-sample.webp 200w,\n/static/76191097103de55829c825fc63f9828a/7f61c/wordcloud-sample.webp 400w,\n/static/76191097103de55829c825fc63f9828a/d00b9/wordcloud-sample.webp 800w,\n/static/76191097103de55829c825fc63f9828a/1ae05/wordcloud-sample.webp 868w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/76191097103de55829c825fc63f9828a/772e8/wordcloud-sample.png 200w,\n/static/76191097103de55829c825fc63f9828a/e17e5/wordcloud-sample.png 400w,\n/static/76191097103de55829c825fc63f9828a/5a190/wordcloud-sample.png 800w,\n/static/76191097103de55829c825fc63f9828a/748b0/wordcloud-sample.png 868w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/76191097103de55829c825fc63f9828a/5a190/wordcloud-sample.png\"\n            alt=\"wordcloud sample\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"wordcloudの作り方実装\" style=\"position:relative;\"><a href=\"#wordcloud%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9%E5%AE%9F%E8%A3%85\" aria-label=\"wordcloudの作り方実装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WordCloudの作り方（実装）</h2>\n<p>自前実装の必要はありません。<a href=\"https://github.com/takuyaa/kuromoji.js/\">kuromoji.js</a>と<a href=\"https://github.com/jasondavies/d3-cloud\">D3-Cloud</a>というライブラリを使えば簡単に実装できます。\nさらに<a href=\"https://github.com/Yoctol/react-d3-cloud\">react-d3-cloud</a>というD3-CloudをReactで使うためのライブラリもあったので、それを使ってReactアプリを実装します。</p>\n<h3 id=\"1-文章を解析して単語出現回数をデータ化-1\" style=\"position:relative;\"><a href=\"#1-%E6%96%87%E7%AB%A0%E3%82%92%E8%A7%A3%E6%9E%90%E3%81%97%E3%81%A6%E5%8D%98%E8%AA%9E%E5%87%BA%E7%8F%BE%E5%9B%9E%E6%95%B0%E3%82%92%E3%83%87%E3%83%BC%E3%82%BF%E5%8C%96-1\" aria-label=\"1 文章を解析して単語出現回数をデータ化 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 文章を解析して単語出現回数をデータ化</h3>\n<p>kuromoji.jsは形態素解析で辞書を使います。\nkuromoji.jsをインストールすると辞書がバンドルされています。\nReactで使う場合は以下のように辞書の場所を移動して、辞書をブラウザから読み込めるようにしておく必要があります。</p>\n<div class=\"gatsby-code-title\">辞書をブラウザから読み込める場所にコピー</div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-a</span> node_modules/kuromoji/dict public/</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<br/>\n<p>kuromoji.jsの解析結果は以下のようになります。\n色々ありますが、今回は<code class=\"language-text\">pos（品詞）</code>と<code class=\"language-text\">surface_form（表層形）</code>または<code class=\"language-text\">basic_form（基本形）</code>のみを使います。</p>\n<div class=\"gatsby-code-title\">kuromoji.js解析結果の形式</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">word_id</span><span class=\"token operator\">:</span> <span class=\"token number\">509800</span><span class=\"token punctuation\">,</span>          <span class=\"token comment\">// 辞書内での単語ID</span>\n  <span class=\"token literal-property property\">word_type</span><span class=\"token operator\">:</span> <span class=\"token string\">'KNOWN'</span><span class=\"token punctuation\">,</span>       <span class=\"token comment\">// 単語タイプ(辞書に登録されている単語ならKNOWN, 未知語ならUNKNOWN)</span>\n  <span class=\"token literal-property property\">word_position</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>         <span class=\"token comment\">// 単語の開始位置</span>\n  <span class=\"token literal-property property\">surface_form</span><span class=\"token operator\">:</span> <span class=\"token string\">'黒文字'</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\">// 表層形</span>\n  <span class=\"token literal-property property\">pos</span><span class=\"token operator\">:</span> <span class=\"token string\">'名詞'</span><span class=\"token punctuation\">,</span>               <span class=\"token comment\">// 品詞</span>\n  <span class=\"token literal-property property\">pos_detail_1</span><span class=\"token operator\">:</span> <span class=\"token string\">'一般'</span><span class=\"token punctuation\">,</span>      <span class=\"token comment\">// 品詞細分類1</span>\n  <span class=\"token literal-property property\">pos_detail_2</span><span class=\"token operator\">:</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// 品詞細分類2</span>\n  <span class=\"token literal-property property\">pos_detail_3</span><span class=\"token operator\">:</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// 品詞細分類3</span>\n  <span class=\"token literal-property property\">conjugated_type</span><span class=\"token operator\">:</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\">// 活用型</span>\n  <span class=\"token literal-property property\">conjugated_form</span><span class=\"token operator\">:</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\">// 活用形</span>\n  <span class=\"token literal-property property\">basic_form</span><span class=\"token operator\">:</span> <span class=\"token string\">'黒文字'</span><span class=\"token punctuation\">,</span>      <span class=\"token comment\">// 基本形</span>\n  <span class=\"token literal-property property\">reading</span><span class=\"token operator\">:</span> <span class=\"token string\">'クロモジ'</span><span class=\"token punctuation\">,</span>       <span class=\"token comment\">// 読み</span>\n  <span class=\"token literal-property property\">pronunciation</span><span class=\"token operator\">:</span> <span class=\"token string\">'クロモジ'</span>  <span class=\"token comment\">// 発音</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<p>Reactコンポーネントでは以下のように実装します。</p>\n<div class=\"gatsby-code-title\">テキスト加工処理</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> kuromoji <span class=\"token keyword\">from</span> <span class=\"token string\">'kuromoji'</span>\n\n<span class=\"token keyword\">const</span> text <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">そこも場合もうその病気らに対して旨の時がしんませ。\n単に事実に使用方はどうかその応用たないでもが思いてならないがも発展思いうべきて、\n...\n</span><span class=\"token template-punctuation string\">`</span></span>\n\n<span class=\"token comment\">// 辞書格納フォルダパス</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">DIC_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">'/dict'</span>\n\n<span class=\"token comment\">// WordCloudの情報として抽出する品詞（助詞、助動詞などは意味がないので拾わない）</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">TARGET_POS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'名詞'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'動詞'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'形容詞'</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">// kuromoji.jsの解析結果の値で特に値がない場合は以下の文字が設定される</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">NO_CONTENT</span> <span class=\"token operator\">=</span> <span class=\"token string\">'*'</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// kuromoji.jsによる形態素解析は非同期なので</span>\n  <span class=\"token comment\">// 解析結果はstateのプロパティとしてコンストラクタで初期化しておく</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">dataForD3Cloud</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">componentWillMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 辞書を読み混んでトークナイザー（形態素解析するための関数）を生成</span>\n    kuromoji<span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">dicPath</span><span class=\"token operator\">:</span> <span class=\"token constant\">DIC_URL</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> tokenizer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">// テキストを引数にして形態素解析</span>\n      <span class=\"token keyword\">const</span> tokens <span class=\"token operator\">=</span> tokenizer<span class=\"token punctuation\">.</span><span class=\"token function\">tokenize</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n\n      <span class=\"token comment\">// 解析結果から単語と出現回数を抽出</span>\n      <span class=\"token keyword\">const</span> dataForD3Cloud <span class=\"token operator\">=</span> tokens\n        <span class=\"token comment\">// pos（品詞）を参照し、'名詞', '動詞', '形容詞'のみを抽出</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">t</span> <span class=\"token operator\">=></span> <span class=\"token constant\">TARGET_POS</span><span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span>pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// 単語を抽出(basic_formかsurface_formに単語が存在する)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">t</span> <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span>basic_form <span class=\"token operator\">===</span> <span class=\"token constant\">NO_CONTENT</span> <span class=\"token operator\">?</span> t<span class=\"token punctuation\">.</span>surface_form <span class=\"token operator\">:</span> t<span class=\"token punctuation\">.</span>basic_form<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// [{text: 単語, value: 出現回数}]の形にReduce</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token punctuation\">,</span> text</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> c<span class=\"token punctuation\">.</span>text <span class=\"token operator\">===</span> text<span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            target<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            data<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              text<span class=\"token punctuation\">,</span>\n              <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token keyword\">return</span> data\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      \n      <span class=\"token comment\">// 加工した解析結果をstateにセット</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>dataForD3Cloud<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 略</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<h3 id=\"2-データをもとにイイ感じの画像出力-1\" style=\"position:relative;\"><a href=\"#2-%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%82%E3%81%A8%E3%81%AB%E3%82%A4%E3%82%A4%E6%84%9F%E3%81%98%E3%81%AE%E7%94%BB%E5%83%8F%E5%87%BA%E5%8A%9B-1\" aria-label=\"2 データをもとにイイ感じの画像出力 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. データをもとにイイ感じの画像出力</h3>\n<p><a href=\"https://github.com/Yoctol/react-d3-cloud\">react-d3-cloud</a>が専用のコンポーネントを提供しているのでそれを使うだけです。</p>\n<div class=\"gatsby-code-title\">WordCloud描画処理</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> WordCloud <span class=\"token keyword\">from</span> <span class=\"token string\">\"react-d3-cloud\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// フォントの大きさを決める関数</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fontSizeMapper</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">word</span> <span class=\"token operator\">=></span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span>word<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> <span class=\"token number\">0.8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">10</span>\n\n<span class=\"token comment\">// フォントの回転位置</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">rotate</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">word</span> <span class=\"token operator\">=></span> word<span class=\"token punctuation\">.</span>value <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">===</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token number\">90</span>\n\n<span class=\"token comment\">// フォントの種類</span>\n<span class=\"token keyword\">const</span> fontFamily <span class=\"token operator\">=</span> <span class=\"token string\">'meiryo'</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 略</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">componentWillMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 略</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"App\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>WordCloud\n          data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>dataForD3Cloud<span class=\"token punctuation\">}</span>\n          fontSizeMapper<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>fontSizeMapper<span class=\"token punctuation\">}</span>\n          rotate<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>rotate<span class=\"token punctuation\">}</span>\n          font<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>fontFamily<span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<p>さて、ここで疑問を持たれる方もいると思います。\n前述の<a href=\"#2-%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%82%E3%81%A8%E3%81%AB%E3%82%A4%E3%82%A4%E6%84%9F%E3%81%98%E3%81%AE%E7%94%BB%E5%83%8F%E5%87%BA%E5%8A%9B\">WordCloudの作り方（原理）> 2. データをもとにイイ感じの画像出力</a>で画像出力するには以下を決定する必要があると述べました。</p>\n<ol>\n<li>フォントの大きさ・・・・・☚コンポーネントで定義した👍</li>\n<li>フォントの回転位置・・・・☚コンポーネントで定義した👍</li>\n<li>フォントの種類・・・・・・☚コンポーネントで定義した👍</li>\n<li>フォントの色・・・・・・・☚コンポーネントで定義してない🤔</li>\n<li>表示位置・・・・・・・・・☚コンポーネントで定義してない🤔</li>\n</ol>\n<p><code class=\"language-text\">4</code>,<code class=\"language-text\">5</code>どうやって決めるのでしょうか？\n実は<code class=\"language-text\">4</code>はreact-d3-cloud内部でよしなり定義してくれていて、\n<code class=\"language-text\">5</code>はD3-Cloudがイイ感じに決めてくれています。</p>\n<p><a href=\"https://github.com/Yoctol/react-d3-cloud/blob/master/src/WordCloud.js#L91\"><strong>↓react-d3-cloud内部ロジック 色定義：WordCloud.js#L91</strong></a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 67\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\">   <span class=\"token keyword\">const</span> layout <span class=\"token operator\">=</span> <span class=\"token function\">cloud</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">font</span><span class=\"token punctuation\">(</span>font<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">words</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">padding</span><span class=\"token punctuation\">(</span>padding<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>rotate<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">fontSize</span><span class=\"token punctuation\">(</span>fontSizeMapper<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">words</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> texts <span class=\"token operator\">=</span> <span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wordCloud<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'svg'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'width'</span><span class=\"token punctuation\">,</span> layout<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">,</span> layout<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'g'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">'transform'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">translate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>layout<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">,</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>layout<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span>\n          <span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>words<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">enter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'font-size'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>size<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'font-family'</span><span class=\"token punctuation\">,</span> font<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">          <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fill'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">fill</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span>          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'text-anchor'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'middle'</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transform'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">translate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">[</span>d<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)rotate(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>d<span class=\"token punctuation\">.</span>rotate<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> d<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<p><a href=\"https://github.com/jasondavies/d3-cloud/blob/master/build/d3.layout.cloud.js#L59-L73\"><strong>↓D3-Cloud内部ロジック 表示位置定義：d3.layout.cloud.js#L59-L73</strong></a></p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 56\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\">    <span class=\"token keyword\">function</span> <span class=\"token function\">step</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">var</span> start <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start <span class=\"token operator\">&lt;</span> timeInterval <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">++</span>i <span class=\"token operator\">&lt;</span> n <span class=\"token operator\">&amp;&amp;</span> timer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">var</span> d <span class=\"token operator\">=</span> data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">        d<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">        d<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token function\">cloudSprite</span><span class=\"token punctuation\">(</span>contextAndRatio<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span>hasText <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">place</span><span class=\"token punctuation\">(</span>board<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> bounds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">          tags<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">          <span class=\"token function\">event</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"word\"</span><span class=\"token punctuation\">,</span> cloud<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bounds<span class=\"token punctuation\">)</span> <span class=\"token function\">cloudBounds</span><span class=\"token punctuation\">(</span>bounds<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">          <span class=\"token keyword\">else</span> bounds <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> d<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> d<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> d<span class=\"token punctuation\">.</span>y <span class=\"token operator\">+</span> d<span class=\"token punctuation\">.</span>y0<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token literal-property property\">x</span><span class=\"token operator\">:</span> d<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> d<span class=\"token punctuation\">.</span>x1<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">y</span><span class=\"token operator\">:</span> d<span class=\"token punctuation\">.</span>y <span class=\"token operator\">+</span> d<span class=\"token punctuation\">.</span>y1<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">          <span class=\"token comment\">// Temporary hack</span></span><span class=\"gatsby-highlight-code-line\">          d<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-=</span> size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">          d<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-=</span> size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">>=</span> n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        cloud<span class=\"token punctuation\">.</span><span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">event</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">,</span> cloud<span class=\"token punctuation\">,</span> tags<span class=\"token punctuation\">,</span> bounds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<br/>\n<p>これによって以下のようなイイ感じのWordCloudを出力することができるのですね。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/76191097103de55829c825fc63f9828a/748b0/wordcloud-sample.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 86%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAENElEQVR42kWS624aZwJAedl9kNXuj0p7UdTLrrorbXerNm0um5hkEjtxHGzHEAzmAzw2twGGuQ9zgYEBhst8PlXVH32BI52jU1DV1lcj3epNG29v1lf/FaPRG2G4FRHexWI28sSbW0s8/dQVP37qCuvOEd26JxqfHRENZ8Ib+0KLI9Hzw5uWF/QajcajgmHqypyULNZy4j6rrEW+6ZH5GotsTa07oTxZUjXWZMuQ3OySGWOw75GLDHu+5zjd5G+2MHKcYkGf6K8yEppmtH/d8uV0tpBc/0duP34hN+0nkvI3cq9dyMDey4XWlQf9WnL1SB4u/yYtN5XGXSjb6/W+lO4xbPtlYawbSnIAMZnl35fHdMIMaV3Dsz+QGg6Zcc9D8xlTD9Ig4VD7gYf3f+bQVfA0nZu7iNNZkncOoFtWsaCPB8phmzL3zTx0l0zjDXz8E/LiW1YRyPsy2/4R8zSA1lMeescs5zEbZ8ju7d8piYB/RfP8+WLHyLSKhYFhKqx06Cr5pjlD2iYPNz8ga09YBrBVzzlUvmQXD8CoQflrHkp/Zd8scij/D7Nj0Rkbubt/wHLdYsG2HQVW5EGUr7SE7Sjl4CRgtgmGDk+vNaR2xso3WfgWmVCQv2qrL5m/KpKefsB7+yzHC5jUh8WCaZoK7Jj7Tj4xbQLTpl+tcFep4N0JXjddfrwJSOczVvOIXesW2b5mmy1IL0tsHYefwtPcywK85qRYsF1X4SBZW3a+negsfJ/edZlho0bzwzGLqcl5x+SPRyr/LvV5fNrntl4Dq0rut9mvFljtcs56xcT0igVT0xTSBdHUz23TxxxPGIk6ekvQrVyxXfm8V3X+8rbPu7bJS7X9ayuCB5g7Dqt370gqtXxu6KiiXiwYuq64C4kX+3k4V0nmNlq1QvtTCa9X53l9wk9VCysdUHXO+e72W150n6JGY9SpSmN4zj5K8kOSMLhVi4WxriuTJehOLV8uq0ytK4aNOoPrCvdC8N2lxmIW4I6GHA+Oed75PyeTDzQHFzitGqo7Jj15l3PfQdcnxYJj2wpAuJrl0fIOyyij1auoF2fcHCtMgym98YhZEiPcBo/bj3k9OkEML0lOzhF+Rvzieb6tVKi3mr8D+zM3PzNP6Rq3DD5fcfvxBLVySaLrZNqIj/oZyvANxf4RT+5/5kR/D2qf2dEL0vOLXG42lPq/bfNKAk4a7Rt+Qw5DTTqDoex+FnIWRHL54UzG//in1HqqrHSqsj9syWb3s2z6ujwK13JomjK0f96vWfBp5L0sOE6kQMAu6+W2NSXwbXbpDl/bsl9twbFhFrNZpiyTlF264iGJSTcrqpnE3e85bNQcNqiTXrFw31a/SmKrF3rmjTkciVG3I1xjIjzPFaHjiNgwRZLEYjENhR/FIg5nIg0dETlj4TmuiD1HRNPZjakPeqVG6dEvx/OxlPZOgfsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/76191097103de55829c825fc63f9828a/ba381/wordcloud-sample.webp 200w,\n/static/76191097103de55829c825fc63f9828a/7f61c/wordcloud-sample.webp 400w,\n/static/76191097103de55829c825fc63f9828a/d00b9/wordcloud-sample.webp 800w,\n/static/76191097103de55829c825fc63f9828a/1ae05/wordcloud-sample.webp 868w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/76191097103de55829c825fc63f9828a/772e8/wordcloud-sample.png 200w,\n/static/76191097103de55829c825fc63f9828a/e17e5/wordcloud-sample.png 400w,\n/static/76191097103de55829c825fc63f9828a/5a190/wordcloud-sample.png 800w,\n/static/76191097103de55829c825fc63f9828a/748b0/wordcloud-sample.png 868w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/76191097103de55829c825fc63f9828a/5a190/wordcloud-sample.png\"\n            alt=\"wordcloud sample\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"その他日本語長文サンプルの準備にはすぐに使えるダミーテキストが便利\" style=\"position:relative;\"><a href=\"#%E3%81%9D%E3%81%AE%E4%BB%96%E6%97%A5%E6%9C%AC%E8%AA%9E%E9%95%B7%E6%96%87%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AE%E6%BA%96%E5%82%99%E3%81%AB%E3%81%AF%E3%81%99%E3%81%90%E3%81%AB%E4%BD%BF%E3%81%88%E3%82%8B%E3%83%80%E3%83%9F%E3%83%BC%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%81%8C%E4%BE%BF%E5%88%A9\" aria-label=\"その他日本語長文サンプルの準備にはすぐに使えるダミーテキストが便利 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>その他：日本語長文サンプルの準備には「すぐに使えるダミーテキスト」が便利</h2>\n<p>WordCloudを作るときにテキトーな日本語文章を大量に用意する必要があります。\nそんな時は下記サイトが便利でした。</p>\n<p><a href=\"https://lipsum.sugutsukaeru.jp/index.cgi\">https://lipsum.sugutsukaeru.jp/index.cgi</a></p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>Pythonじゃないと形態素解析とWordCloud生成は無理かなと思っていましたが、JavaScriptでもライブラリが提供されていました。JavaScriptであればブラウザ上で処理を行えるので、たとえば入力フォームに入力した文字列をインプットにWordCloudを生成するなど、インタラクティブな操作が可能です。ただし生成に時間がかかるので、実際使うときはユーザーに生成中の旨をフィードバックするようなUIにする必要があるでしょう🍅</p>","excerpt":"なにこれ WordCloudをJSだけで生成したい。Pythonとか使わずにフロントエンドだけでやりたい。というモチベーションで、\nkuromoji.jsとD3-Cloudを使って文字列をインプットにWordCloudを描画するReact…","frontmatter":{"slug":"/wordcloud-with-kuromoji-d3cloud-react","title":"React + kuromoji.js + D3-CloudでWordCloudをブラウザに描画","date":"2019-05-04T12:40:00.000+09:00","tags":["React","kuromoji.js","d3.js","d3Cloud","データ可視化","形態素解析","WordCloud"],"keywords":["React"],"thumbnail":"thumbnail/2019/05/wordcloud-with-kuromoji-d3cloud-react.png","category":null}}],"tag":"d3.js","tagCounts":[{"text":"Gatsby","size":26},{"text":"React","size":8},{"text":"Vue.js","size":8},{"text":"GraphQL","size":6},{"text":"AWS","size":5},{"text":"AppSync","size":5},{"text":"Vuetify","size":5},{"text":"GatsbyPlugin","size":4},{"text":"Netlify","size":3},{"text":"VueI18n","size":3},{"text":"WordCloud","size":3},{"text":"d3.js","size":3},{"text":"d3Cloud","size":3},{"text":"kuromoji.js","size":3},{"text":"mdx-deck","size":3},{"text":"キーボード","size":3},{"text":"データ可視化","size":3},{"text":"勉強会","size":3},{"text":"形態素解析","size":3},{"text":"Apollo Client","size":2},{"text":"AutoHotkey","size":2},{"text":"Cognito","size":2},{"text":"CrossPlatform","size":2},{"text":"LT","size":2},{"text":"Mobile","size":2},{"text":"Node.js","size":2},{"text":"Nuxt.js","size":2},{"text":"ReactNative","size":2},{"text":"SNS","size":2},{"text":"SRE","size":2},{"text":"VeeValidate","size":2},{"text":"code-surfer","size":2},{"text":"gatsby-image","size":2},{"text":"markdown","size":2},{"text":"mdx","size":2},{"text":"スライド","size":2},{"text":"ブログ","size":2},{"text":"プレゼン","size":2},{"text":"作業効率化","size":2},{"text":"読書感想","size":2},{"text":"Amplify","size":1},{"text":"Axios","size":1},{"text":"CSS","size":1},{"text":"CSSModules","size":1},{"text":"CircleCI","size":1},{"text":"Connpass","size":1},{"text":"Cytoscape.js","size":1},{"text":"DynamoDB","size":1},{"text":"Flutter","size":1},{"text":"Fromik","size":1},{"text":"Gatsby theme","size":1},{"text":"Git","size":1},{"text":"GitHub","size":1},{"text":"Github-Pages","size":1},{"text":"Graphpack","size":1},{"text":"Https化","size":1},{"text":"Hugo","size":1},{"text":"Iframely","size":1},{"text":"Ionic","size":1},{"text":"JJUG CCC","size":1},{"text":"JSON-LD","size":1},{"text":"Java","size":1},{"text":"JavaScript","size":1},{"text":"Kotlin","size":1},{"text":"NetlifyForms","size":1},{"text":"OGP","size":1},{"text":"PWA","size":1},{"text":"RPG","size":1},{"text":"RSS","size":1},{"text":"SER","size":1},{"text":"Schema-org","size":1},{"text":"Vim","size":1},{"text":"Vimium","size":1},{"text":"Vuex","size":1},{"text":"Windows","size":1},{"text":"Zapier","size":1},{"text":"clip-path","size":1},{"text":"gatsby-image-sharp","size":1},{"text":"gatsby-plugin-feed","size":1},{"text":"gatsy-image","size":1},{"text":"golang","size":1},{"text":"oEmbed","size":1},{"text":"rehype","size":1},{"text":"remark","size":1},{"text":"serverless","size":1},{"text":"typescript","size":1},{"text":"unified","size":1},{"text":"イベントレポート","size":1},{"text":"カスタムドメイン","size":1},{"text":"デュアルキーボード","size":1},{"text":"パソコン","size":1},{"text":"ランチャー","size":1},{"text":"リンク集","size":1},{"text":"埋め込みコード","size":1},{"text":"肩こり","size":1}]}},"staticQueryHashes":["3868140423","4185443638","467257065"],"slicesMap":{}}